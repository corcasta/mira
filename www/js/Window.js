var TASKBAR_HEIGHT=0;function dummy(){}class XpraWindow{constructor(client,wid,x,y,w,h,metadata,override_redirect,tray,client_properties,geometry_callback,mouse_move_callback,mouse_down_callback,mouse_up_callback,mouse_scroll_callback,set_focus_callback,window_closed_callback,scale){this.client=client,this.wid=wid,this.div=document.getElementById(wid),this.x=x,this.y=y,this.w=w,this.h=h,this.scale=scale,this.metadata={},this.override_redirect=override_redirect,this.tray=tray,this.has_alpha=!1,this.client_properties=client_properties,this.set_focus_cb=set_focus_callback||dummy,this.mouse_move_cb=mouse_move_callback||dummy,this.mouse_down_cb=mouse_down_callback||dummy,this.mouse_up_cb=mouse_up_callback||dummy,this.mouse_scroll_cb=mouse_scroll_callback||dummy,this.geometry_cb=geometry_callback||dummy,this.window_closed_cb=window_closed_callback||dummy,this.debug_categories=client.debug_categories,this.canvas=null,this.init_canvas(),this.title="",this.windowtype=null,this.fullscreen=!1,this.saved_geometry=null,this.minimized=!1,this.maximized=!1,this.focused=!1,this.decorations=!0,this.has_decorations=!1,this.resizable=!1,this.stacking_layer=0,this.icon=null,this.leftoffset=Number.parseInt(jQuery(this.div).css("border-left-width"),10),this.rightoffset=Number.parseInt(jQuery(this.div).css("border-right-width"),10),this.topoffset=Number.parseInt(jQuery(this.div).css("border-top-width"),10),this.bottomoffset=Number.parseInt(jQuery(this.div).css("border-bottom-width"),10),this.update_metadata(metadata,!0),jQuery(this.div).addClass("window"),this.windowtype&&jQuery(this.div).addClass("window-"+this.windowtype);x=metadata.fullscreen??!1;this.client.server_is_desktop||this.client.server_is_shadow?(jQuery(this.div).addClass("desktop"),this.resizable=!1):this.tray?jQuery(this.div).addClass("tray"):this.override_redirect?jQuery(this.div).addClass("override-redirect"):x||""!=this.windowtype&&"NORMAL"!=this.windowtype&&"DIALOG"!=this.windowtype&&"UTILITY"!=this.windowtype||(this.resizable=!0),(this.resizable||metadata.decorations)&&this.add_window_decorations(),jQuery(this.div).prepend(`<div id="spinner${wid}" class="spinneroverlay"><div class="spinnermiddle"><div class="spinner"></div></div></div>`),this.spinnerdiv=jQuery("#spinner"+wid),this.cursor_data=null,this.pointer_down=-1,this.pointer_last_x=0,this.pointer_last_y=0,this.screen_resized(),this.updateCSSGeometry(),this.update_metadata(metadata)}log(){this.client&&this.client.log.apply(this.client,arguments)}warn(){this.client&&this.client.warn.apply(this.client,arguments)}error(){this.client&&this.client.error.apply(this.client,arguments)}exc(){this.client&&this.client.exc.apply(this.client,arguments)}debug(){this.client&&this.client.debug.apply(this.client,arguments)}add_window_decorations(){this.has_decorations=!0;var wid=this.wid,head=(jQuery(this.div).addClass("border"),`<div id="head${wid}" class="windowhead"> `+`<span class="windowicon"><img class="windowicon" id="windowicon${wid}" /></span> `+`<span class="windowtitle" id="title${wid}">${this.title}</span> `+'<span class="windowbuttons"> ');jQuery(this.div).hasClass("modal")||(head+=`<span id="minimize${wid}"><img src="icons/minimize.png" /></span>`),head+=`<span id="maximize${wid}"><img src="icons/maximize.png" /></span> `+`<span id="close${wid}"><img src="icons/close.png" /></span> `+"</span></div>",jQuery(this.div).prepend(head),1!==this.scale&&jQuery(this.div).draggable({transform:!0}),jQuery(this.div).draggable({cancel:"canvas"}),jQuery("#head"+wid).click(event_=>{this.minimized||this.focus()}),jQuery(this.div).on("dragstart",event_=>{this.client.release_buttons(event_,this),this.focus(),this.client.mouse_grabbed=!0}),jQuery(this.div).on("dragstop",(event_,ui)=>{this.client.mouse_grabbed=!1,this.handle_moved(ui)}),1!==this.scale&&jQuery(this.div).resizable({transform:!0}),jQuery(this.div).resizable({containment:"parent",helper:"ui-resizable-helper",handles:"n, e, s, w, ne, se, sw, nw"}),jQuery(this.div).on("resizestart",(event_,ui)=>{this.client.do_window_mouse_click(event_,this,!1),this.client.mouse_grabbed=!0}),jQuery(this.div).on("resizestop",(event_,ui)=>{this.handle_resized(ui),this.focus(),this.client.mouse_grabbed=!1,setTimeout(()=>this.client.request_refresh(wid),200),setTimeout(()=>this.client.request_refresh(wid),500)}),this.d_header="#head"+wid,this.d_closebtn="#close"+wid,this.d_maximizebtn="#maximize"+wid,this.d_minimizebtn="#minimize"+wid,this.resizable?(jQuery(this.d_header).dblclick(()=>this.toggle_maximized()),jQuery(this.d_closebtn).click(()=>this.window_closed_cb(this)),jQuery(this.d_maximizebtn).click(()=>this.toggle_maximized()),jQuery(this.d_minimizebtn).click(()=>this.toggle_minimized())):(jQuery(this.d_closebtn).hide(),jQuery(this.d_maximizebtn).hide(),jQuery("#windowlistitemmax"+wid).hide(),jQuery(this.d_minimizebtn).hide()),this.topoffset=this.topoffset+Number.parseInt(jQuery(this.d_header).css("height"),10),jQuery(this.div).mousedown(e=>e.stopPropagation()),jQuery(this.d_header).click(e=>{this.minimized||0!==$(e.target).parents(".windowbuttons").length||this.focus()})}init_canvas(){this.canvas=null,jQuery(this.div).find("canvas").remove();var canvas=document.createElement("canvas");this.client.try_gpu&&$(canvas).addClass("gpu-trigger"),canvas.width=this.w,canvas.height=this.h,this.canvas=canvas,this.div.append(canvas),this.client.offscreen_api?this.transfer_canvas(canvas):(this.canvas_ctx=this.canvas.getContext("2d"),this.canvas_ctx.imageSmoothingEnabled=!1,this.init_offscreen_canvas(),this.draw_canvas=this.offscreen_canvas,this.paint_queue=[],this.paint_pending=0),this.register_canvas_mouse_events(this.canvas),this.register_canvas_pointer_events(this.canvas)}transfer_canvas(canvas){canvas=canvas.transferControlToOffscreen();this.client.decode_worker.postMessage({cmd:"canvas",wid:this.wid,canvas:canvas,debug:this.debug_categories.includes("draw")},[canvas])}init_offscreen_canvas(){this.offscreen_canvas=document.createElement("canvas"),this.offscreen_canvas.width=this.w,this.offscreen_canvas.height=this.h,this.offscreen_canvas_ctx=this.offscreen_canvas.getContext("2d"),this.offscreen_canvas_ctx.imageSmoothingEnabled=!1}swap_buffers(){this.debug("draw","swap_buffers"),this.draw_canvas=this.offscreen_canvas,this.init_offscreen_canvas(),this.offscreen_canvas_ctx.drawImage(this.draw_canvas,0,0)}register_canvas_mouse_events(canvas){jQuery(canvas).mousedown(e=>{this.on_mousedown(e)}),jQuery(canvas).mouseup(e=>{this.on_mouseup(e)}),jQuery(canvas).mousemove(e=>{this.on_mousemove(e)})}register_canvas_pointer_events(canvas){var me;window.PointerEvent&&(canvas.addEventListener("pointerdown",event_=>{this.debug("mouse","pointerdown:",event_),"touch"==event_.pointerType&&(this.pointer_down=event_.pointerId,this.pointer_last_x=event_.offsetX,this.pointer_last_y=event_.offsetY)}),canvas.addEventListener("mousemove",event_=>{var dx,dy,mult;this.debug("mouse","mousemove:",event_),this.pointer_down==event_.pointerId&&(dx=event_.offsetX-this.pointer_last_x,dy=event_.offsetY-this.pointer_last_y,this.pointer_last_x=event_.offsetX,this.pointer_last_y=event_.offsetY,mult=20*(window.devicePixelRatio||1),event_.wheelDeltaX=Math.round(dx*mult),event_.wheelDeltaY=Math.round(dy*mult),this.on_mousescroll(event_))}),canvas.addEventListener("pointerup",event_=>{this.debug("mouse","pointerup:",event_),this.pointer_down=-1}),canvas.addEventListener("pointercancel",event_=>{this.debug("mouse","pointercancel:",event_),this.pointer_down=-1}),canvas.addEventListener("pointerout",event_=>{this.debug("mouse","pointerout:",event_)}),me=this,Utilities.isEventSupported("wheel"))&&canvas.addEventListener("wheel",function(e){return me.on_mousescroll(e),e.stopPropagation(),e.preventDefault()},!1)}set_spinner(state){state?this.spinnerdiv.hide():this.spinnerdiv.css("display","table")}ensure_visible(){var oldx,oldy,ww,desktop_size;return!(!this.client.server_is_desktop&&!this.client.server_is_shadow&&!this.override_redirect&&(oldx=this.x,oldy=this.y,ww=(desktop_size=this.client._get_desktop_size())[0],desktop_size=desktop_size[1],oldx<this.leftoffset&&oldx+this.w<=80?this.x=80-this.w+this.leftoffset:ww-80<=oldx&&(this.x=Math.min(oldx,ww-80)),oldy<=this.topoffset&&oldy<=80?this.y=Number.parseInt(this.topoffset):desktop_size-80<=oldy&&(this.y=Math.min(oldy,desktop_size-80)),this.debug("geometry","ensure_visible() oldx=",oldx,"oldy=",oldy,"x=",this.x,"y=",this.y),oldx!=this.x||oldy!=this.y)&&(this.updateCSSGeometry(),1))}updateCanvasGeometry(){this.client.offscreen_api?this.client.decode_worker.postMessage({cmd:"canvas-geo",wid:this.wid,w:this.w,h:this.h}):(this.canvas.width!=this.w&&(this.canvas.width=this.w),this.canvas.height!=this.h&&(this.canvas.height=this.h),this.offscreen_canvas.width!=this.w&&(this.offscreen_canvas.width=this.w),this.offscreen_canvas.height!=this.h&&(this.offscreen_canvas.height=this.h))}updateCSSGeometry(){this.updateCanvasGeometry(),this.client.server_is_desktop||this.client.server_is_shadow?(this.client.server_resize_exact&&jQuery(this.div).css("top",0),jQuery(this.div).position({of:jQuery("#screen")})):(this.outerH=this.h+this.topoffset+this.bottomoffset,this.outerW=this.w+this.leftoffset+this.rightoffset,jQuery(this.div).css("width",this.outerW),jQuery(this.div).css("height",this.outerH),this.outerX=this.x-this.leftoffset,this.outerY=this.y-this.topoffset,jQuery(this.div).css("left",this.outerX),jQuery(this.div).css("top",this.outerY),this.debug("geometry","updateCSSGeometry() left=",this.outerX,", top=",this.outerY,", width=",this.outerW,", height=",this.outerH))}focus(){this.set_focus_cb(this)}updateFocus(){var source;this.focused?(jQuery(this.div).addClass("windowinfocus"),this.client.session_name?jQuery("title").text(client.session_name):jQuery("title").text(location.pathname.replaceAll("/","")+": "+this.title),null!==this.icon?(source=this.update_icon(this.icon.width,this.icon.height,this.icon.encoding,this.icon.img_data),jQuery("#favicon").attr("href",source)):jQuery("#favicon").attr("href","favicon.png")):jQuery(this.div).removeClass("windowinfocus")}suspend(){}resume(){this.init_canvas()}on_mousemove(e){return this.mouse_move_cb(e,this)}on_mousedown(e){return this.mouse_down_cb(e,this)}on_mouseup(e){return this.mouse_up_cb(e,this)}on_mousescroll(e){return this.mouse_scroll_cb(e,this)}toString(){return`Window(${this.wid})`}update_zindex(){var z=5e3+this.stacking_layer;this.tray?z=0:this.override_redirect||this.client.server_is_desktop||this.client.server_is_shadow?z=3e4:"DROPDOWN"==this.windowtype||"TOOLTIP"==this.windowtype||"POPUP_MENU"==this.windowtype||"MENU"==this.windowtype||"COMBO"==this.windowtype?z=2e4:"UTILITY"!=this.windowtype&&"DIALOG"!=this.windowtype||(z=15e3),this.metadata.above?z+=5e3:this.metadata.below&&(z-=5e3),this.focused&&(z+=2500),jQuery(this.div).css("z-index",z)}update_metadata(metadata,safe){for(var attrname in this.debug("main","update_metadata(",metadata,")"),metadata)this.metadata[attrname]=metadata[attrname];safe?this.set_metadata_safe(metadata):this.set_metadata(metadata),this.update_zindex()}set_metadata_safe(metadata){var attribute;"title"in metadata&&(title=Utilities.s(metadata.title),this.title!=title)&&(this.title=title,this.log("title=",this.title),jQuery("#title"+this.wid).html(this.title),title=Utilities.trimString(this.title,30),jQuery("#windowlistitemtitle"+this.wid).text(title)),"has-alpha"in metadata&&(this.has_alpha=metadata["has-alpha"]),"window-type"in metadata&&(this.windowtype=Utilities.s(metadata["window-type"][0])),"decorations"in metadata&&(this.decorations=metadata.decorations,this._set_decorated(this.decorations),this.updateCSSGeometry(),this.handle_resized(),this.apply_size_constraints()),"opacity"in metadata&&(title=(title=metadata.opacity)<0?1:title/4294967296,jQuery(this.div).css("opacity",""+title)),"iconic"in metadata&&this.set_minimized(1==metadata.iconic);for(attribute of["modal","above","below"])attribute in metadata&&(metadata[attribute]?jQuery(this.div).addClass(attribute):jQuery(this.div).removeClass(attribute));if(this.resizable&&"size-constraints"in metadata&&this.apply_size_constraints(),"class-instance"in metadata){var tclass,wm_class=metadata["class-instance"],title=jQuery(this.div).prop("classList");if(title)for(var class_ of title)0===(tclass=""+class_).indexOf("wmclass-")&&wm_class&&!wm_class.includes(tclass)&&jQuery(this.div).removeClass(tclass);if(wm_class)for(var element of wm_class)(tclass=Utilities.s(element).replace(/[^\dA-Za-z]/g,""))&&!jQuery(this.div).hasClass(tclass)&&jQuery(this.div).addClass("wmclass-"+tclass)}}apply_size_constraints(){var hdec,max_size,size_constraints,minh,min_size,maxh;this.resizable&&(this.maximized?jQuery(this.div).draggable("disable"):jQuery(this.div).draggable("enable"),hdec=0,this.decorations&&(hdec=jQuery("#head"+this.wid).outerHeight(!0)),max_size=min_size=null,(size_constraints=this.metadata["size-constraints"])&&(min_size=size_constraints["minimum-size"],max_size=size_constraints["maximum-size"]),minh=size_constraints=null,min_size&&(size_constraints=min_size[0]+0,minh=min_size[1]+hdec),maxh=min_size=null,max_size&&(min_size=max_size[0]+0,maxh=max_size[1]+hdec),0<size_constraints&&size_constraints==min_size&&0<minh&&minh==maxh?(jQuery(this.d_maximizebtn).hide(),jQuery("#windowlistitemmax"+this.wid).hide(),jQuery(this.div).resizable("disable")):(jQuery(this.d_maximizebtn).show(),this.maximized?jQuery(this.div).resizable("disable"):jQuery(this.div).resizable("enable")),this.maximized||(jQuery(this.div).resizable("option","minWidth",size_constraints),jQuery(this.div).resizable("option","minHeight",minh),jQuery(this.div).resizable("option","maxWidth",min_size),jQuery(this.div).resizable("option","maxHeight",maxh)))}set_metadata(metadata){this.set_metadata_safe(metadata),"fullscreen"in metadata&&this.set_fullscreen(1==metadata.fullscreen),"maximized"in metadata&&this.set_maximized(1==metadata.maximized)}save_geometry(){this.saved_geometry={x:this.x,y:this.y,w:this.w,h:this.h},this.debug("geometry","save_geometry() saved-geometry=",this.saved_geometry)}restore_geometry(){null!=this.saved_geometry&&(this.x=this.saved_geometry.x,this.y=this.saved_geometry.y,this.w=this.saved_geometry.w,this.h=this.saved_geometry.h,this.debug("geometry","restore_geometry() saved-geometry=",this.saved_geometry),this.saved_geometry=null,this.handle_resized(),this.focus())}set_maximized(maximized){jQuery(this.div).is(":hidden")&&jQuery(this.div).show(),this.maximized!=maximized&&(this.max_save_restore(maximized),this.maximized=maximized,this.handle_resized(),this.focus(),this.apply_size_constraints())}toggle_maximized(){this.set_maximized(!this.maximized)}set_minimized(minimized){this.minimized!=minimized&&((this.minimized=minimized)?jQuery(this.div).hide(200):jQuery(this.div).show(200))}toggle_minimized(){var geom=this.get_internal_geometry();this.set_minimized(!this.minimized),this.minimized?(this.client.send([PACKET_TYPES.unmap_window,this.wid,!0]),this.stacking_layer=0,this.client.focus==this.wid&&this.client.auto_focus()):(this.client.send([PACKET_TYPES.map_window,this.wid,geom.x,geom.y,geom.w,geom.h,this.client_properties]),this.client.focus=-1,this.client.set_focus(this))}set_fullscreen(fullscreen){this.fullscreen!=fullscreen&&(this.resizable&&(fullscreen?this._set_decorated(!1):this._set_decorated(this.decorations)),this.max_save_restore(fullscreen),this.fullscreen=fullscreen,this.updateCSSGeometry(),this.handle_resized(),this.focus())}_set_decorated(decorated){this.topoffset=Number.parseInt(jQuery(this.div).css("border-top-width"),10),decorated?(jQuery("#head"+this.wid).show(),jQuery(this.div).removeClass("undecorated"),jQuery(this.div).addClass("window"),this.d_header&&(this.topoffset=this.topoffset+Number.parseInt(jQuery(this.d_header).css("height"),10),this.debug("geometry","_set_decorated(",decorated,") new topoffset=",self.topoffset))):(jQuery("#head"+this.wid).hide(),jQuery(this.div).removeClass("window"),jQuery(this.div).addClass("undecorated"))}max_save_restore(use_all_space){use_all_space?(this.save_geometry(),this.fill_screen()):this.restore_geometry()}fill_screen(){var screen_size=this.client._get_desktop_size();this.x=this.leftoffset,this.y=this.topoffset,this.w=screen_size[0]-this.leftoffset-this.rightoffset,this.h=screen_size[1]-this.topoffset-this.bottomoffset-TASKBAR_HEIGHT,this.debug("geometry","fill_screen() ",this.x,this.y,this.w,this.h)}handle_resized(e){this.debug("geometry","handle_resized(",e,")"),e&&(this.x=this.x+Math.round(e.position.left-e.originalPosition.left),this.y=this.y+Math.round(e.position.top-e.originalPosition.top),this.w=Math.round(e.size.width)-this.leftoffset-this.rightoffset,this.h=Math.round(e.size.height)-this.topoffset-this.bottomoffset),this.updateCSSGeometry(),this.geometry_cb(this)}handle_moved(e){var left=Math.round(e.position.left),top=Math.round(e.position.top);this.debug("geometry","handle_moved(",e,") left=",left,", top=",top),this.x=left+this.leftoffset,this.y=top+this.topoffset,this.ensure_visible(),this.geometry_cb(this)}screen_resized(){var ids;this.debug("geometry","screen_resized() server_is_desktop=",this.client.server_is_desktop,", server_is_shadow=",this.client.server_is_shadow),this.client.server_is_desktop&&this.match_screen_size(),!this.client.server_is_shadow||0!==(ids=Object.keys(this.client.id_to_window)).length&&ids[0]!=this.wid||this.recenter(),(this.fullscreen||this.maximized)&&(this.fill_screen(),this.handle_resized()),this.ensure_visible()||this.geometry_cb(this)}recenter(force_update_geometry){var x=this.x,y=this.y;this.debug("geometry","recenter() x=",x,", y=",y,", desktop size: ",this.client.desktop_width,this.client.desktop_height),x=Math.round((this.client.desktop_width-this.w)/2),y=Math.round((this.client.desktop_height-this.h)/2),this.x!=x||this.y!=y||force_update_geometry?(this.debug("geometry","window re-centered to:",x,y),this.x=x,this.y=y,this.updateCSSGeometry(),this.geometry_cb(this)):this.debug("geometry","recenter() unchanged at ",x,y),(this.x<0||this.y<0)&&this.warn("window does not fit in canvas, offsets: ",x,y)}match_screen_size(){var maxw=this.client.desktop_width,maxh=this.client.desktop_height,neww=0,newh=0;if(this.client.server_resize_exact)this.log("resizing to exact size:",neww=maxw,newh=maxh);else{if(0===this.client.server_screen_sizes.length)return void this.recenter();var best=0,w=0,h=0,screen_sizes=this.client.server_screen_sizes;for(screen_size of screen_sizes)w=screen_size[0],h=screen_size[1],w<=maxw&&h<=maxh&&best<w*h&&(best=w*h,neww=w,newh=h);if(0==neww&&0==newh){best=0;for(var screen_size of screen_sizes)w=screen_size[0],h=screen_size[1],(0==best||w*h<best)&&(best=w*h,neww=w,newh=h)}this.log("best screen size:",neww,newh)}this.w=neww,this.h=newh,this.recenter(!0)}move_resize(x,y,w,h){this.debug("geometry","move_resize(",x,y,w,h,")"),this.w==w&&this.h==h&&this.x==x&&this.y==y||(this.w=w,this.h=h,this.x=x,this.y=y,this.ensure_visible()?this.updateCSSGeometry():this.geometry_cb(this))}move(x,y){this.debug("geometry","move(",x,y,")"),this.move_resize(x,y,this.w,this.h)}resize(w,h){this.debug("geometry","resize(",w,h,")"),this.move_resize(this.x,this.y,w,h)}initiate_moveresize(mousedown_event,x_root,y_root,direction,button,source_indication){var dir_str=MOVERESIZE_DIRECTION_STRING[direction];this.log("initiate_moveresize",dir_str,[x_root,y_root,direction,button,source_indication]),direction==MOVERESIZE_MOVE&&mousedown_event?((dir_str=mousedown_event).type="mousedown.draggable",dir_str.target=this.div[0],jQuery(this.div).trigger(dir_str)):direction==MOVERESIZE_CANCEL?(jQuery(this.div).draggable("disable"),jQuery(this.div).draggable("enable")):direction in MOVERESIZE_DIRECTION_JS_NAME&&(x_root=MOVERESIZE_DIRECTION_JS_NAME[direction],y_root=jQuery(this.div).find(".ui-resizable-handle.ui-resizable-"+x_root).first())&&(button=y_root.offset().left,source_indication=y_root.offset().top,y_root.trigger("mouseover"),y_root.trigger({type:"mousedown",which:1,pageX:button,pageY:source_indication}))}get_internal_geometry(){return{x:this.x,y:this.y,w:this.w,h:this.h}}update_icon(width,height,encoding,img_data){this.icon={width:width,height:height,encoding:encoding,img_data:img_data};width="favicon.png";if("png"==encoding){if($("#title"+this.wid).css("left",32),"string"==typeof img_data){for(var uint=new Uint8Array(img_data.length),index=0;index<img_data.length;++index)uint[index]=img_data.charCodeAt(index);img_data=uint}width=this.construct_base64_image_url(encoding,img_data)}return jQuery("#windowicon"+this.wid).attr("src",width),jQuery("#windowlistitemicon"+this.wid).attr("src",width),width}reset_cursor(){jQuery("#"+this.wid).css("cursor","default"),this.cursor_data=null}set_cursor(encoding,w,h,xhot,yhot,img_data){var window_element,me,temporary_img;function set_cursor_url(url,x,y,w,h){var url_string=`url('${url}')`;window_element.css("cursor",url_string+", default"),window_element.css("cursor",url_string+` ${x} ${y}, auto`),me.cursor_data=[url,x,y,w,h]}"png"!=encoding?this.warn("received an invalid cursor encoding:",encoding):(window_element=jQuery("#"+this.wid),encoding=this.construct_base64_image_url(encoding,img_data),me=this,img_data=detectZoom.zoom(),1==(img_data=Math.round(4*img_data)==2*Math.round(2*img_data)?Math.round(2*img_data)/2:img_data)||Utilities.isMacOS()?set_cursor_url(encoding,xhot,yhot,w,h):((temporary_img=new Image).addEventListener("load",()=>{var canvas=document.createElement("canvas"),context=canvas.getContext("2d");context.imageSmoothingEnabled=!1,canvas.width=Math.round(w*window.devicePixelRatio),canvas.height=Math.round(h*window.devicePixelRatio),context.drawImage(temporary_img,0,0,canvas.width,canvas.height),set_cursor_url(canvas.toDataURL(),Math.round(xhot*window.devicePixelRatio),Math.round(yhot*window.devicePixelRatio),Math.round(canvas.width),Math.round(canvas.height))}),temporary_img.src=encoding))}eos(){}draw(){(this.has_alpha||this.tray)&&this.canvas_ctx.clearRect(0,0,this.draw_canvas.width,this.draw_canvas.height),this.canvas_ctx.drawImage(this.draw_canvas,0,0)}paint(){var item;this.client.decode_worker?Reflect.apply(this.do_paint,this,arguments):(item=Array.prototype.slice.call(arguments),this.paint_queue.push(item),this.may_paint_now())}may_paint_now(){this.debug("draw","may_paint_now() paint pending=",this.paint_pending,", paint queue length=",this.paint_queue.length);for(var now=performance.now();(0==this.paint_pending||2e3<=now-this.paint_pending)&&0<this.paint_queue.length;){this.paint_pending=now;var item=this.paint_queue.shift();this.do_paint.apply(this,item),now=performance.now()}}paint_box(color,px,py,pw,ph){this.offscreen_canvas_ctx.strokeStyle=color,this.offscreen_canvas_ctx.lineWidth=2,this.offscreen_canvas_ctx.strokeRect(px,py,pw,ph)}do_paint(packet,decode_callback){var rgb_data,img,image,paint_coding,me=this,x=packet[2],y=packet[3],width=packet[4],height=packet[5],img_data=packet[7],options=packet[10]||{},coding=Utilities.s(packet[6]),enc_width=width,enc_height=height,options=options.scaled_size,options=(options&&(enc_width=options[0],enc_height=options[1]),coding.startsWith("bitmap:"));function painted(skip_box){me.paint_pending=0,!skip_box&&me.debug_categories.includes("draw")&&(skip_box=DEFAULT_BOX_COLORS[coding]||"white",me.paint_box(skip_box,x,y,width,height)),decode_callback()}function paint_error(e){me.error("error painting",coding,e),me.paint_pending=0,decode_callback(""+e)}function paint_bitmap(){me.offscreen_canvas_ctx.clearRect(x,y,img_data.width,img_data.height),me.offscreen_canvas_ctx.drawImage(img_data,x,y),painted(),me.may_paint_now()}options?(coding=coding.split(":")[1],this.debug("draw",coding,img_data," at ",x+","+y,") focused=",this.focused)):this.debug("draw","do_paint(",img_data.length," bytes of",coding," data ",width,"x",height," at ",x,",",y,") focused=",this.focused);try{if("void"==coding)painted(!0),this.may_paint_now();else if("rgb32"==coding||"rgb24"==coding)options?paint_bitmap():(rgb_data=decode_rgb(packet),(img=this.offscreen_canvas_ctx.createImageData(enc_width,enc_height)).data.set(rgb_data),this.offscreen_canvas_ctx.putImageData(img,x,y,0,0,width,height),painted(),this.may_paint_now());else if("jpeg"==coding||coding.startsWith("png")||"webp"==coding)options?paint_bitmap():(paint_coding=((image=new Image).addEventListener("load",()=>{0==image.width||0==image.height?paint_error(`invalid image size: ${image.width}x`+image.height):(this.offscreen_canvas_ctx.clearRect(x,y,width,height),this.offscreen_canvas_ctx.drawImage(image,x,y,width,height),painted()),this.may_paint_now()}),image.onerror=()=>{paint_error(`failed to load ${coding} into image tag`),this.may_paint_now()},coding.split("/")[0]),image.src=this.construct_base64_image_url(paint_coding,img_data));else if("h264"==coding)paint_error("h264 decoding is only supported via the decode workers"),this.may_paint_now();else if("scroll"==coding){for(var index=0,stop=img_data.length;index<stop;++index){var scroll_data=img_data[index],sx=(this.debug("draw","scroll",index,":",scroll_data),scroll_data[0]),sy=scroll_data[1],sw=scroll_data[2],sh=scroll_data[3],xdelta=scroll_data[4],ydelta=scroll_data[5];this.offscreen_canvas_ctx.drawImage(this.draw_canvas,sx,sy,sw,sh,sx+xdelta,sy+ydelta,sw,sh),this.debug_categories.includes("draw")&&this.paint_box("brown",sx+xdelta,sy+ydelta,sw,sh)}painted(!0),this.may_paint_now()}else paint_error("unsupported encoding")}catch(error){enc_width=packet[8];this.exc(error,"error painting",coding,"sequence no",enc_width),paint_error(error)}}construct_base64_image_url(encoding,imageDataArrayBuffer){return`data:image/${encoding};base64,`+Utilities.ArrayBufferToBase64(imageDataArrayBuffer)}destroy(){this.div.remove()}}