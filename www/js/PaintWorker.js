importScripts("./Constants.js");var KEEP_STILLS=!1;class XpraPaintWorker{constructor(){this.offscreen_canvas=new Map,this.offscreen_canvas_still=new Map,this.debug=!1}add_canvas(wid,canvas,debug){this.offscreen_canvas.set(wid,canvas),this.offscreen_canvas_still.set(wid,new OffscreenCanvas(canvas.width,canvas.height)),debug&&(this.debug=!0)}update_canvas(wid,w,h){var canvas=this.offscreen_canvas.get(wid),wid=this.offscreen_canvas_still.get(wid);null==canvas||canvas.width==w&&canvas.height==h||(canvas.width=w,canvas.height=h,wid.width=w,wid.height=h)}paint_packet(wid,coding,image,x,y,width,height){var painted=!1;try{"function"==typeof requestAnimationFrame&&(requestAnimationFrame(()=>{this.do_paint_packet(wid,coding,image,x,y,width,height)}),painted=!0)}catch{painted=!1}finally{painted||this.do_paint_packet(wid,coding,image,x,y,width,height)}}do_paint_packet(wid,coding,image,x,y,width,height){var context=this.offscreen_canvas.get(wid).getContext("2d");if(coding.startsWith("bitmap"))context.imageSmoothingEnabled=!1,context.clearRect(x,y,width,height),context.drawImage(image,x,y,width,height),this.paint_box(coding,context,x,y,width,height);else if("scroll"==coding){var canvas=this.offscreen_canvas.get(wid);context.imageSmoothingEnabled=!1;for(var index=0,stop=image.length;index<stop;++index){var scroll_data=image[index],sx=scroll_data[0],sy=scroll_data[1],sw=scroll_data[2],sh=scroll_data[3],xdelta=scroll_data[4],scroll_data=scroll_data[5];context.drawImage(canvas,sx,sy,sw,sh,sx+xdelta,sy+scroll_data,sw,sh),this.paint_box(coding,context,sx,sy,sw,sh)}}else coding.startsWith("frame")&&(context.drawImage(image,x,y,width,height),image.close(),this.paint_box(coding,context,x,y,width,height));image=null,KEEP_STILLS&&setTimeout(()=>this.update_still(wid),0)}paint_box(coding,context,px,py,pw,ph){this.debug&&(coding=coding.split(":")[1]||"",coding=DEFAULT_BOX_COLORS[coding])&&(context.strokeStyle=coding,context.lineWidth=2,context.strokeRect(px,py,pw,ph))}update_still(wid){var canvas=this.offscreen_canvas.get(wid);this.offscreen_canvas_still.get(wid).getContext("2d").drawImage(canvas,0,0,canvas.width,canvas.height,0,0,canvas.width,canvas.height)}delete_canvas(wid){this.offscreen_canvas.delete(wid),this.offscreen_canvas_still.delete(wid)}redraw(wid){var canvas,still;KEEP_STILLS?(canvas=this.offscreen_canvas.get(wid),still=this.offscreen_canvas_still.get(wid),canvas.getContext("2d").drawImage(still,0,0,still.width,still.height,0,0,still.width,still.height)):console.warn(`PaintWorker was asked for a redraw on window ${wid} but no still is available!`)}}var xpraPaintWorker=new XpraPaintWorker;onmessage=function(e){var data=e.data;switch(data.cmd){case"paint":xpraPaintWorker.paint_packet(data.wid,data.coding,data.image,data.x,data.y,data.w,data.h),data.image=null;break;case"remove":xpraPaintWorker.delete_canvas(data.wid);break;case"canvas":console.log("canvas transfer for window",data.wid,":",data.canvas,data.debug),data.canvas&&xpraPaintWorker.add_canvas(data.wid,data.canvas,data.debug);break;case"canvas-geo":xpraPaintWorker.update_canvas(data.wid,data.w,data.h);break;case"redraw":xpraPaintWorker.redraw(data.wid);break;default:console.error("Offscreen decode worker got unknown message: "+data.cmd)}};