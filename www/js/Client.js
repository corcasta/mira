var XPRA_CLIENT_FORCE_NO_WORKER=!1,CLIPBOARD_IMAGES=!0,CLIPBOARD_EVENT_DELAY=100,DECODE_WORKER=!!window.createImageBitmap,SHOW_START_MENU=!0,FILE_SIZE_LIMIT=4294967296,FILE_CHUNKS_SIZE=131072,MAX_CONCURRENT_FILES=5,CHUNK_TIMEOUT=1e4,MODAL_FOCUS=!0,TEXT_PLAIN="text/plain",UTF8_STRING="UTF8_STRING",TEXT_HTML="text/html",FLOAT_MENU_SELECTOR="#float_menu",PASTEBOARD_SELECTOR="#pasteboard",WINDOW_PREVIEW_SELECTOR="#window_preview",BELL_SOUND="data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=",METADATA_SUPPORTED=["fullscreen","maximized","iconic","above","below","title","size-hints","class-instance","transient-for","window-type","has-alpha","decorations","override-redirect","tray","modal","opacity"],TRY_GPU_TRIGGER=!0;function truncate(input){var s;return input&&(5<(s=input.toString()).length?s.slice(0,5)+"...":s)}class XpraClient{constructor(container){if(this.container=document.querySelector("#"+container),!this.container)throw new Error("invalid container element");window.jQuery&&jQuery(window).resize(jQuery.debounce(250,e=>this._screen_resized(e))),this.protocol=null,this.init_settings(),this.init_state()}init_settings(){this.host=null,this.port=null,this.ssl=null,this.webtransport=!1,this.path="",this.username="",this.passwords=[],this.insecure=!1,this.uri="",this.packet_encoder=null,this.sharing=!1,this.open_url=!0,this.steal=!0,this.remote_logging=!0,this.debug_categories=[],this.start_new_session=null,this.clipboard_enabled=!1,this.clipboard_poll=!1,this.clipboard_preferred_format=TEXT_PLAIN,this.file_transfer=!1,this.remote_file_size_limit=0,this.remote_file_chunks=0,this.send_chunks_in_progress=new Map,this.receive_chunks_in_progress=new Map,this.keyboard_layout=null,this.printing=!1,this.key_packets=[],this.clipboard_delayed_event_time=0,this.scale=1,this.vrefresh=-1,this.bandwidth_limit=0,this.reconnect=!0,this.reconnect_count=5,this.reconnect_in_progress=!1,this.reconnect_delay=1e3,this.reconnect_attempt=0,this.swap_keys=Utilities.isMacOS(),this.HELLO_TIMEOUT=3e4,this.OPEN_TIMEOUT=1e4,this.PING_TIMEOUT=15e3,this.PING_GRACE=2e3,this.PING_FREQUENCY=5e3,this.INFO_FREQUENCY=1e3,this.uuid=Utilities.getHexUUID(),this.offscreen_api=!1,this.try_gpu=TRY_GPU_TRIGGER,this.init_encodings()}init_encodings(){this.encoding="auto",this.supported_encodings=["jpeg","png","png/P","png/L","rgb","rgb32","rgb24","scroll","void"],this.check_encodings=["jpeg","png","png/P","png/L","rgb","rgb32","rgb24","scroll","webp","void","avif"];this.encoding_options={"":this.encoding,icons:{max_size:[30,30]},transparency:!0,rgb_lz4:lz4&&"undefined"!=lz4.decode,"decoder-speed":{video:0},"color-gamut":Utilities.getColorGamut(),video_scaling:!0,video_max_size:[1024,768],full_csc_modes:{mpeg1:["YUV420P"],h264:["YUV420P"],"mpeg4+mp4":["YUV420P"],"h264+mp4":["YUV420P"],"vp8+webm":["YUV420P"],webp:["BGRX","BGRA"],jpeg:["BGRX","BGRA","BGR","RGBX","RGBA","RGB","YUV420P","YUV422P","YUV444P"],vp8:["YUV420P"]},h264:{"score-delta":80,YUV420P:{profile:"baseline",level:"2.1",cabac:!1,"deblocking-filter":!1,"fast-decode":!0}},"h264+mp4":{"score-delta":50,YUV420P:{profile:"baseline",level:"3.0"}},vp8:{"score-delta":70},"mpeg4+mp4":{"score-delta":40},"vp8+webm":{"score-delta":40}}}init_state(){this.connected=!1,this.session_name=void 0,this.desktop_width=0,this.desktop_height=0,this.server_remote_logging=!1,this.server_start_time=-1,this.client_start_time=new Date,this.capabilities={},this.RGB_FORMATS=["RGBX","RGBA","RGB"],this.disconnect_reason=null,this.password_prompt_fn=null,this.keycloak_prompt_fn=null,this.audio=null,this.audio_enabled=!1,this.audio_mediasource_enabled=null!=MediaSourceUtil.getMediaSourceClass(),this.audio_aurora_enabled="undefined"!=typeof AV&&null!=AV&&null!=AV.Decoder&&null!=AV.Player.fromXpraSource,this.audio_codecs={},this.audio_framework=null,this.audio_aurora_ctx=null,this.audio_codec=null,this.audio_context=new AudioContext,this.audio_state=null,this.aurora_codecs={},this.mediasource_codecs={},this.encryption=!1,this.encryption_key=null,this.cipher_in_caps=null,this.cipher_out_caps=null,this.browser_language=Utilities.getFirstBrowserLanguage(),this.browser_language_change_embargo_time=0,this.key_layout=null,this.last_keycode_pressed=0,this.last_key_packet=[],this.buttons_pressed=new Set,this.last_button_event=[-1,!1,-1,-1],this.mousedown_event=null,this.last_mouse_x=null,this.last_mouse_y=null,this.wheel_delta_x=0,this.wheel_delta_y=0,this.mouse_grabbed=!1,this.scroll_reverse_x=!1,this.scroll_reverse_y="auto",this.clipboard_direction=default_settings.clipboard_direction||"both",this.clipboard_datatype=null,this.clipboard_buffer="",this.clipboard_server_buffers={},this.clipboard_pending=!1,this.clipboard_targets=[TEXT_HTML,UTF8_STRING,"TEXT","STRING",TEXT_PLAIN],this.remote_printing=!1,this.remote_file_transfer=!1,this.remote_open_files=!1,this.hello_timer=null,this.open_timer=null,this.info_timer=null,this.info_request_pending=!1,this.server_last_info={},this.ping_timeout_timer=null,this.ping_grace_timer=null,this.ping_timer=null,this.last_ping_server_time=0,this.last_ping_local_time=0,this.last_ping_echoed_time=0,this.server_ping_latency=0,this.client_ping_latency=0,this.server_load=null,this.server_ok=!1,this.decode_worker=null,this.toolbar_position="top",this.server_display="",this.server_platform="",this.server_resize_exact=!1,this.server_screen_sizes=[],this.server_is_desktop=!1,this.server_is_shadow=!1,this.server_readonly=!1,this.server_connection_data=!1,this.xdg_menu=null,this.id_to_window={},this.ui_events=0,this.pending_redraw=[],this.draw_pending=0,this.topwindow=null,this.topindex=0,this.focus=0;var me=this,screen_element=jQuery("#screen"),screen_element=(screen_element.mousedown(e=>this.on_mousedown(e)),screen_element.mouseup(e=>this.on_mouseup(e)),document.getElementById("screen").addEventListener("mousemove",e=>this.on_mousemove(e)),document.querySelector("#screen"));Utilities.isEventSupported("wheel")?screen_element.addEventListener("wheel",function(e){return me.on_mousescroll(e),e.preventDefault()},!1):this.warn("browser does not support scroll wheel events")}send(){this.debug("network","sending a",arguments[0],"packet"),this.protocol&&this.protocol.send.apply(this.protocol,arguments)}send_log(level,arguments_){if(this.remote_logging&&this.server_remote_logging&&this.connected)try{var sargs=[];for(argument of arguments_)sargs.push(unescape(encodeURIComponent(String(argument))));this.send([PACKET_TYPES.logging,level,sargs])}catch{for(var index in this.cerror("remote logging failed"),arguments_){var argument=arguments_[index];this.clog(" argument",index,typeof argument,":",`'${argument}'`)}}}exc(){var exception=arguments[0],arguments_=[...arguments];if(0<(arguments_=arguments_.splice(1)).length&&this.cerror(arguments_),exception.stack)try{this.send_log(40,[exception.stack])}catch{}}error(){this.send_log(40,arguments),Reflect.apply(this.cerror,this,arguments)}cerror(){Utilities.cerror.apply(Utilities,arguments)}warn(){this.send_log(30,arguments),Reflect.apply(this.cwarn,this,arguments)}cwarn(){Utilities.cwarn.apply(Utilities,arguments)}log(){this.send_log(20,arguments),Reflect.apply(this.clog,this,arguments)}clog(){Utilities.clog.apply(Utilities,arguments)}debug(){var category=arguments[0],arguments_=[...arguments];this.debug_categories.includes(category)&&("network"!=category&&this.send_log(10,arguments_),Reflect.apply(this.cdebug,this,arguments))}cdebug(){Utilities.cdebug.apply(Utilities,arguments)}init(ignore_blacklist){this.on_connection_progress("Initializing","",20),this.init_audio(ignore_blacklist),this.init_packet_handlers(),this.init_keyboard(),1!==this.scale&&(this.container.style.width=100*this.scale+"%",this.container.style.height=100*this.scale+"%",this.container.style.transform=`scale(${1/this.scale})`,this.container.style.transformOrigin="top left")}init_packet_handlers(){this.packet_handlers={[PACKET_TYPES.ack_file_chunk]:this._process_ack_file_chunk,[PACKET_TYPES.bell]:this._process_bell,[PACKET_TYPES.challenge]:this._process_challenge,[PACKET_TYPES.clipboard_request]:this._process_clipboard_request,[PACKET_TYPES.clipboard_token]:this._process_clipboard_token,[PACKET_TYPES.close]:this._process_close,[PACKET_TYPES.configure_override_redirect]:this._process_configure_override_redirect,[PACKET_TYPES.cursor]:this._process_cursor,[PACKET_TYPES.desktop_size]:this._process_desktop_size,[PACKET_TYPES.disconnect]:this._process_disconnect,[PACKET_TYPES.draw]:this._process_draw,[PACKET_TYPES.encodings]:this._process_encodings,[PACKET_TYPES.eos]:this._process_eos,[PACKET_TYPES.error]:this._process_error,[PACKET_TYPES.hello]:this._process_hello,[PACKET_TYPES.info_response]:this._process_info_response,[PACKET_TYPES.initiate_moveresize]:this._process_initiate_moveresize,[PACKET_TYPES.lost_window]:this._process_lost_window,[PACKET_TYPES.new_override_redirect]:this._process_new_override_redirect,[PACKET_TYPES.new_tray]:this._process_new_tray,[PACKET_TYPES.new_window]:this._process_new_window,[PACKET_TYPES.notify_close]:this._process_notify_close,[PACKET_TYPES.notify_show]:this._process_notify_show,[PACKET_TYPES.open]:this._process_open,[PACKET_TYPES.open_url]:this._process_open_url,[PACKET_TYPES.ping]:this._process_ping,[PACKET_TYPES.ping_echo]:this._process_ping_echo,[PACKET_TYPES.pointer_position]:this._process_pointer_position,[PACKET_TYPES.raise_window]:this._process_raise_window,[PACKET_TYPES.send_file]:this._process_send_file,[PACKET_TYPES.send_file_chunk]:this._process_send_file_chunk,[PACKET_TYPES.set_clipboard_enabled]:this._process_set_clipboard_enabled,[PACKET_TYPES.setting_change]:this._process_setting_change,[PACKET_TYPES.sound_data]:this._process_sound_data,[PACKET_TYPES.startup_complete]:this._process_startup_complete,[PACKET_TYPES.window_icon]:this._process_window_icon,[PACKET_TYPES.window_metadata]:this._process_window_metadata,[PACKET_TYPES.window_move_resize]:this._process_window_move_resize,[PACKET_TYPES.window_resized]:this._process_window_resized}}on_connection_progress(state,details,progress){this.clog(state,details)}callback_close(reason){this.clog("connection closed: "+(reason=void 0===reason?"unknown reason":reason))}connect(){var details=this.host+":"+this.port+this.path;this.ssl&&(details+=" with ssl"),this.schedule_open_timer(),this.on_connection_progress("Connecting to server",details,40),!this.encryption||this.encryption_key&&""!=this.encryption_key?this.initialize_workers():this.disconnect("no key specified for encryption")}initialize_workers(){var decode_worker,safe_encodings=["jpeg","png","png/P","png/L","rgb","rgb32","rgb24","scroll","void"];window.Worker?(this.clog("we have webworker support"),this._do_connect(!0),DECODE_WORKER?(this.offscreen_api&&(this.offscreen_api=DECODE_WORKER&&XpraOffscreenWorker.isAvailable(this.ssl)),(decode_worker=this.offscreen_api?(this.set_encoding_option("video_max_size",[4096,4096]),this.clog("using offscreen decode worker"),new Worker("js/OffscreenDecodeWorker.js")):(this.clog("using decode worker"),new Worker("js/DecodeWorker.js"))).addEventListener("message",e=>{var packet,wid,width,height,coding,packet_sequence,data=e.data;if(data.draw)this.do_process_draw(data.draw,data.start);else if(data.error)e=data.error,wid=(packet=data.packet)[1],width=packet[2],height=packet[3],coding=packet[6],packet_sequence=packet[8],this.clog("decode error on ",coding,"packet sequence",packet_sequence,":",e),this.offscreen_api||this.clog(" pixel data:",packet[7]),this.do_send_damage_sequence(packet_sequence,wid,width,height,-1,e);else switch(data.result){case!0:var formats=[...data.formats];this.clog("we can decode using a worker:",decode_worker),this.supported_encodings=formats,this.clog("full list of supported encodings:",this.supported_encodings),this.decode_worker=decode_worker;break;case!1:this.clog("we can't decode using a worker: "+data.errors),this.decode_worker=!1;break;default:this.clog("client got unknown message from the decode worker"),this.decode_worker=!1}},!1),this.clog("decode worker will check:",this.check_encodings),decode_worker.postMessage({cmd:"check",encodings:this.check_encodings})):(this.supported_encodings=safe_encodings,this.decode_worker=!1,this.offscreen_api=!1)):(this.supported_encodings=safe_encodings,this.offscreen_api=!1,this.decode_worker=!1,this.clog("no webworker support at all."),this._do_connect(!1))}_do_connect(with_worker){this.webtransport?this.protocol=new XpraWebTransportProtocol:this.protocol=new(with_worker&&!XPRA_CLIENT_FORCE_NO_WORKER?XpraProtocolWorkerHost:XpraProtocol),this.open_protocol()}open_protocol(){this.protocol.set_packet_handler(packet=>this._route_packet(packet));var uri="";uri=(uri=this.webtransport?"https":this.ssl?"wss":"ws")+"://"+this.host,this.port&&(uri+=":"+this.port),uri+=this.path,this.uri=uri,this.on_connection_progress("Opening WebSocket connection",uri,50),this.protocol.open(uri),console.log("open_protocol() done")}request_refresh(wid){this.send([PACKET_TYPES.buffer_refresh,wid,0,100,{"refresh-now":!0,batch:{reset:!0}},{}])}redraw_windows(){for(var wid in this.id_to_window){wid=this.id_to_window[wid];this.request_redraw(wid)}}remove_windows(){for(var wid in this.id_to_window){wid=this.id_to_window[wid];window.removeWindowListItem(wid.wid),wid.destroy()}}send_close_window(win){this.send([PACKET_TYPES.close_window,win.wid])}close_protocol(){this.connected=!1,this.protocol&&(this.protocol.close(),this.protocol.terminate(),this.protocol=null)}clear_timers(){this.stop_info_timer(),this.cancel_hello_timer(),this.ping_timer&&(clearTimeout(this.ping_timer),this.ping_timer=null),this.ping_timeout_timer&&(clearTimeout(this.ping_timeout_timer),this.ping_timeout_timer=null),this.ping_grace_timer&&(clearTimeout(this.ping_grace_timer),this.ping_grace_timer=null)}set_encoding(encoding){this.clog("encoding:",encoding),this.encoding=encoding}set_encoding_option(option,value){this.clog("encoding: ",option,"=",value),this.encoding_options[option]=value}_route_packet(packet){var packet_type=Utilities.s(packet[0]),function_=(this.debug("network","received a",packet_type,"packet"),this.packet_handlers[packet_type]);null==function_?(this.cerror("no packet handler for ",packet_type),this.clog(packet)):function_.call(this,packet)}_screen_resized(event){if(this.connected&&(this.container.clientWidth!=this.desktop_width||this.container.clientHeight!=this.desktop_height)){this.desktop_width=this.container.clientWidth,this.desktop_height=this.container.clientHeight;var index,newsize=[this.desktop_width,this.desktop_height],newsize=[PACKET_TYPES.desktop_size,newsize[0],newsize[1],this._get_screen_sizes()];for(index in this.send(newsize),this.id_to_window){var pattern,win=this.id_to_window[index];win.screen_resized(),void 0!==default_settings&&void 0!==default_settings.auto_fullscreen&&0<default_settings.auto_fullscreen.length&&(pattern=new RegExp(`.*${default_settings.auto_fullscreen}.*`),!1===win.fullscreen)&&pattern.test(win.metadata.title)&&(clog("auto fullscreen window: "+win.metadata.title),win.set_fullscreen(!0),win.screen_resized()),!1===this.fullscreen&&this.client.is_window_desktop(win)&&(clog("auto fullscreen desktop window: "+this.metadata.title),this.set_fullscreen(!0),this.screen_resized())}this.position_float_menu()}}init_keyboard(){this.query_keyboard_map(),this.num_lock_modifier=null,this.alt_modifier=null,this.control_modifier="control",this.meta_modifier=null,this.altgr_modifier=null,this.altgr_state=!1,this.capture_keyboard=!1,document.addEventListener("keydown",e=>{var number_slides,current_slide,next_index,preview_element=$(WINDOW_PREVIEW_SELECTOR);if("Escape"===e.code&&preview_element.is(":visible"))return client.toggle_window_preview(),e.stopPropagation()||e.preventDefault();if("Tab"===e.code){if(preview_element.is(":visible"))return number_slides=$(".window-preview-item-container").length,next_index=current_slide=preview_element.slick("slickCurrentSlide"),next_index=e.shiftKey?(current_slide-1)%number_slides:(current_slide+1)%number_slides,preview_element.slick("goTo",next_index,!0),e.stopPropagation()||e.preventDefault();if(e.altKey)return client.toggle_window_preview((e,slick)=>{var number_slides=slick.slideCount,next_index=(slick.currentSlide+1)%number_slides;setTimeout(()=>{slick.goTo(next_index,!0)},10)}),e.stopPropagation()||e.preventDefault()}this._keyb_onkeydown(e)||e.preventDefault()}),document.addEventListener("keyup",e=>{if(("Tab"===e.code||e.code.startsWith("Alt"))&&$(WINDOW_PREVIEW_SELECTOR).is(":visible"))return e.code.startsWith("Alt")&&client.toggle_window_preview(),e.stopPropagation()||e.preventDefault();this._keyb_onkeyup(e)||e.preventDefault()})}query_keyboard_map(){var keyboard=navigator.keyboard;this.keyboard_map={},navigator.keyboard&&(keyboard.getLayoutMap().then(keyboardLayoutMap=>{clog("got a keyboard layout map:",keyboardLayoutMap),clog("keys:",[...keyboardLayoutMap.keys()]);for(var key of keyboardLayoutMap.keys()){var value=keyboardLayoutMap[key];cdebug("keyboard",key,"=",value),this.keyboard_map[key]=value}}),keyboard.addEventListener)&&keyboard.addEventListener("layoutchange",()=>this.clog("keyboard layout has changed!"))}_keyb_get_modifiers(event){event=get_event_modifiers(event);return this.translate_modifiers(event)}translate_modifiers(modifiers){var alt=this.alt_modifier,control=this.control_modifier,meta=this.meta_modifier,altgr=this.altgr_modifier,new_modifiers=(this.swap_keys&&(meta=this.control_modifier,control=this.meta_modifier),[...modifiers]),index=modifiers.indexOf("meta");return 0<=index&&meta&&(new_modifiers[index]=meta),0<=(index=modifiers.indexOf("control"))&&control&&(new_modifiers[index]=control),0<=(index=modifiers.indexOf("alt"))&&alt&&(new_modifiers[index]=alt),0<=(index=modifiers.indexOf("numlock"))&&(this.num_lock_modifier?new_modifiers[index]=this.num_lock_modifier:new_modifiers.splice(index,1)),0<=(index=modifiers.indexOf("capslock"))&&(new_modifiers[index]="lock"),this.altgr_state&&altgr&&!new_modifiers.includes(altgr)&&(new_modifiers.push(altgr),0<=(index=new_modifiers.indexOf(alt))&&new_modifiers.splice(index,1),0<=(index=new_modifiers.indexOf(control)))&&new_modifiers.splice(index,1),new_modifiers}_check_browser_language(key_layout){var l,now=performance.now();now<this.browser_language_change_embargo_time||(null!=(l=key_layout||((l=Utilities.getFirstBrowserLanguage())&&this.browser_language!=l?(this.clog("browser language changed from",this.browser_language,"to",l),this.browser_language=l,Utilities.getKeyboardLayout()):this._get_keyboard_layout()||"us"))&&this.key_layout!=l?(this.key_layout=l,this.clog("keyboard layout changed from",this.key_layout,"to",key_layout),this.send([PACKET_TYPES.layout_changed,l,""]),this.browser_language_change_embargo_time=now+1e3):this.browser_language_change_embargo_time=now+100)}_keyb_process(pressed,event){var keycode,keystring,unpress_now,keyname,key_language,dead,capslock,map_string,clipboard_modifier,clipboard_modifier_keys,me;return!!this.server_readonly||!this.capture_keyboard||(keyname=event.code||"",229!=(keycode=event.which||event.keyCode)?(keystring=event.key||String.fromCharCode(keycode),unpress_now=!1,this.debug("keyboard","last keycode pressed=",this.last_keycode_pressed,", keycode=",keycode,", pressed=",pressed,", str=",keystring),(dead="dead"==keystring.toLowerCase())&&(this.last_keycode_pressed!=keycode&&!pressed||pressed)&&(unpress_now=pressed=!0),this.last_keycode_pressed=pressed?keycode:0,this.debug("keyboard","processKeyEvent(",pressed,", ",event,") key=",keyname,"keycode=",keycode,"dead=",dead),144==keycode&&pressed&&(this.num_lock=!this.num_lock),key_language=null,map_string=this.keyboard_map[keyname],dead&&map_string&&map_string in DEAD_KEYS?(keyname=DEAD_KEYS[map_string],keystring=map_string,this.debug("keyboard","dead key:",keyname)):keyname in KEY_TO_NAME?keyname=KEY_TO_NAME[keyname]:""==keyname&&keystring in KEY_TO_NAME?keyname=KEY_TO_NAME[keystring]:keyname!=keystring&&keystring in NUMPAD_TO_NAME?(keyname=NUMPAD_TO_NAME[keystring],this.num_lock="0123456789.".includes(keyname)):keystring in CHAR_TO_NAME?(keyname=CHAR_TO_NAME[keystring]).includes("_")&&(dead=keyname.split("_")[0],key_language=KEYSYM_TO_LAYOUT[dead]):(keycode in CHARCODE_TO_NAME&&(keyname=CHARCODE_TO_NAME[keycode]),event.getModifierState&&event.getModifierState("Shift")&&keycode in CHARCODE_TO_NAME_SHIFTED&&(keyname=CHARCODE_TO_NAME_SHIFTED[keycode])),this._check_browser_language(key_language),keyname.match("_L$")&&2==event.location&&(keyname=keyname.replace("_L","_R")),("AltGraph"==keystring||"Alt_R"==keyname&&(Utilities.isWindows()||Utilities.isMacOS())||"Alt_L"==keyname&&Utilities.isMacOS())&&(this.altgr_state=pressed,keyname="ISO_Level3_Shift",keystring="AltGraph"),map_string=get_event_modifiers(event),dead=keycode,event=(key_language=this._keyb_get_modifiers(event)).includes("shift"),capslock=keystring=(capslock=key_language.includes("capslock"))&&event||!capslock&&!event?keystring.toLowerCase():keystring,this.swap_keys&&("Control_L"==keyname?(keyname="Meta_L",keystring="meta"):"Meta_L"==keyname?(keyname="Control_L",keystring="control"):"Control_R"==keyname?(keyname="Meta_R",keystring="meta"):"Meta_R"==keyname&&(keyname="Control_R",keystring="control")),pressed&&Utilities.isMacOS()&&map_string.includes("meta")&&"meta"!=capslock&&(unpress_now=!0),capslock=!1,this.clipboard_enabled&&"to-server"!==client.clipboard_direction&&(clipboard_modifier_keys=["Control_L","Control_R","Shift_L","Shift_R"],clipboard_modifier="control",Utilities.isMacOS()&&(clipboard_modifier_keys=["Meta_L","Meta_R","Shift_L","Shift_R"],clipboard_modifier="meta"),clipboard_modifier_keys.includes(keyname)&&(this.debug("keyboard","passing clipboard modifier key event to browser:",keyname),capslock=!0),event&&"Insert"==keyname&&(this.debug("keyboard","passing clipboard combination Shift+Insert to browser"),capslock=!0),!map_string.includes(clipboard_modifier)||"c"!=(clipboard_modifier_keys=keyname.toLowerCase())&&"x"!=clipboard_modifier_keys&&"v"!=clipboard_modifier_keys||(this.debug("keyboard","passing clipboard combination to browser:",clipboard_modifier,"+",keyname),capslock=!0,"v"==clipboard_modifier_keys&&(this.clipboard_delayed_event_time=performance.now()+CLIPBOARD_EVENT_DELAY))),null!=this.topwindow&&(event=this.topwindow,map_string=[PACKET_TYPES.key_action,event,keyname,pressed,key_language,dead,keystring,keycode,0],this.key_packets.push(map_string),unpress_now&&(map_string=[PACKET_TYPES.key_action,event,keyname,!1,key_language,dead,keystring,keycode,0],this.key_packets.push(map_string)),clipboard_modifier=0,clipboard_modifier_keys=performance.now(),this.clipboard_delayed_event_time>clipboard_modifier_keys&&(clipboard_modifier=this.clipboard_delayed_event_time-clipboard_modifier_keys),me=this,setTimeout(()=>{for(;0<this.key_packets.length;){var key_packet=me.key_packets.shift();this.last_key_packet=key_packet,this.send(key_packet)}},clipboard_modifier)),"F11"==keyname&&(this.debug("keyboard","allowing default handler for",keyname),capslock=!0),capslock):void 0)}_keyb_onkeydown(event){return this._keyb_process(!0,event)}_keyb_onkeyup(event){return this._keyb_process(!1,event)}_get_keyboard_layout(){return this.debug("keyboard","_get_keyboard_layout() keyboard_layout=",this.keyboard_layout),this.keyboard_layout||Utilities.getKeyboardLayout()}_get_keycodes(){var kc,keycode,keycodes=[];for(keycode in CHARCODE_TO_NAME)kc=Number.parseInt(keycode),keycodes.push([kc,CHARCODE_TO_NAME[keycode],kc,0,0]);return keycodes}_get_desktop_size(){return[this.desktop_width,this.desktop_height]}_get_DPI(){var dpi_div=document.querySelector("#dpi");return null!=dpi_div&&0<dpi_div.offsetWidth&&0<dpi_div.offsetHeight?Math.round((dpi_div.offsetWidth+dpi_div.offsetHeight)/2):"deviceXDPI"in screen?(screen.systemXDPI+screen.systemYDPI)/2:96}_get_screen_sizes(){var dpi=this._get_DPI(),screen_size=[this.container.clientWidth,this.container.clientHeight],wmm=Math.round(25.4*screen_size[0]/dpi),dpi=Math.round(25.4*screen_size[1]/dpi),monitor=["Canvas",0,0,screen_size[0],screen_size[1],wmm,dpi],name="HTML";if(navigator.userAgentData)for(var brands=navigator.userAgentData.brands,index=0;index<brands.length;index++){var brand_info=brands[index],brand=brand_info.brand;!brand||brand.startsWith("Not")||brand.endsWith("Brand")||(name=brand+" "+brand_info.version)}return[[name,screen_size[0],screen_size[1],wmm,dpi,[monitor],0,0,screen_size[0],screen_size[1]]]}_update_capabilities(appendobj){for(var attribute in appendobj)this.capabilities[attribute]=appendobj[attribute]}_check_server_echo(ping_sent_time){var last=this.server_ok;if(this.server_ok=this.last_ping_echoed_time>=ping_sent_time,last!=this.server_ok)for(var index in this.server_ok?this.clog("server connection is OK"):this.clog("server connection is not responding, drawing spinners..."),this.id_to_window)this.id_to_window[index].set_spinner(this.server_ok)}_check_echo_timeout(ping_time){this.reconnect_in_progress||0<this.last_ping_echoed_time&&this.last_ping_echoed_time<ping_time&&(this.reconnect&&this.reconnect_attempt<this.reconnect_count?(this.warn("ping timeout - reconnecting"),this.reconnect_attempt++,this.do_reconnect()):this.disconnect(`server ping timeout, waited ${this.PING_TIMEOUT}ms without a response`))}_emit_event(event_type){var event=document.createEvent("Event");event.initEvent(event_type,!0,!0),document.dispatchEvent(event)}emit_connection_lost(event_type){this._emit_event("connection-lost")}emit_connection_established(event_type){this._emit_event("connection-established")}_send_hello(counter){null==this.decode_worker?(0==(counter=counter||0)?(this.on_connection_progress("Waiting for decode worker","",90),this.clog("waiting for decode worker to finish initializing")):100<counter&&this.do_send_hello(null,null),setTimeout(()=>this._send_hello(counter+1),100)):this.do_send_hello(null,null)}do_send_hello(challenge_response,client_salt){for(var key in this._make_hello_base(),0<this.passwords.length&&!challenge_response?(this.capabilities.challenge=!0,this.clog("sending partial hello")):(this.clog("sending hello"),this._make_hello()),challenge_response&&(this._update_capabilities({challenge_response:challenge_response}),client_salt)&&this._update_capabilities({challenge_client_salt:client_salt}),this.clog("sending hello capabilities",this.capabilities),this.capabilities){if(null==key)throw new Error("invalid null key in hello packet data");if(null==this.capabilities[key])throw new Error(`invalid null value for key ${key} in hello packet data`)}this.send([PACKET_TYPES.hello,this.capabilities]),this.schedule_hello_timer()}_make_hello_base(){this.capabilities={},this._update_capabilities({version:Utilities.VERSION,client_type:"HTML5",display:this.server_display||"",build:this._get_build_caps(),platform:this._get_platform_caps(),"session-type":Utilities.getSimpleUserAgentString(),"session-type.full":navigator.userAgent,username:this.username,uuid:this.uuid,argv:[window.location.href],share:this.sharing,steal:this.steal,"mouse.show":!0,vrefresh:this.vrefresh,"file-chunks":FILE_CHUNKS_SIZE,"setting-change":!0,"xdg-menu-update":!0,"xdg-menu":!0}),this._update_capabilities(this._get_network_caps()),this.encryption&&(this.cipher_in_caps=this._get_cipher_caps(),this._update_capabilities({encryption:this.cipher_in_caps}),console.info("setting cipher in caps=",JSON.stringify(this.cipher_in_caps)),this.protocol.set_cipher_in(this.cipher_in_caps,this.encryption_key)),this.start_new_session&&this._update_capabilities({"start-new-session":this.start_new_session})}_make_hello(){this.desktop_width=this.container.clientWidth,this.desktop_height=this.container.clientHeight,this.key_layout=this._get_keyboard_layout(),this._update_capabilities({auto_refresh_delay:500,"metadata.supported":METADATA_SUPPORTED,encodings:{"":this.supported_encodings,core:this.supported_encodings,rgb_formats:this.RGB_FORMATS,"window-icon":["png"],cursor:["png"],packet:!0},encoding:this._get_encoding_caps(),audio:this._get_audio_caps(),clipboard:this._get_clipboard_caps(),keymap:this._get_keymap_caps(),file:this._get_file_caps(),wants:["audio"],windows:!0,"window.pre-map":!0,keyboard:!0,desktop_size:[this.desktop_width,this.desktop_height],desktop_mode_size:[this.desktop_width,this.desktop_height],screen_sizes:this._get_screen_sizes(),dpi:{x:this._get_DPI(),y:this._get_DPI()},notifications:{enabled:!0},cursors:!0,bell:!0,system_tray:!0,named_cursors:!1})}_get_file_caps(){return{enabled:!0,printing:this.printing,"open-url":this.open_url,"size-limit":33554432}}_get_network_caps(){var digests=this._get_digests();return{digest:digests,"salt-digest":digests,compression_level:1,rencodeplus:!0,brotli:"undefined"!=typeof BrotliDecode,lz4:lz4&&"undefined"!=lz4.decode,"bandwidth-limit":this.bandwidth_limit,"connection-data":Utilities.getConnectionInfo(),network:{pings:5}}}_get_digests(){var digests=["xor","keycloak"];if(void 0!==crypto.subtle)try{this.debug("network","crypto.subtle=",crypto.subtle);for(var hash of["sha1","sha256","sha384","sha512"])digests.push("hmac+"+hash);this.debug("network","digests:",digests)}catch{this.cerror("Error probing crypto.subtle digests")}else this.clog("cryptography library 'crypto.subtle' not found");return digests}_get_cipher_caps(){var enc=this.encryption.split("-")[0];if("AES"!=enc)throw`invalid encryption specified: '${enc}'`;return{cipher:enc,mode:this.encryption.split("-")[1]||"CBC",iv:Utilities.getSecureRandomString(16),key_salt:Utilities.getSecureRandomBytes(64),key_size:32,key_hash:"SHA1",key_stretch_iterations:1e3,"padding.options":["PKCS#7"],"always-pad":!0,stream:!1}}_get_build_caps(){return{revision:Utilities.REVISION,local_modifications:Utilities.LOCAL_MODIFICATIONS,branch:Utilities.BRANCH}}_get_platform_caps(){return{"":Utilities.getPlatformName(),name:Utilities.getPlatformName(),processor:Utilities.getPlatformProcessor(),platform:navigator.appVersion}}_get_audio_caps(){return{receive:!0,send:!0,decoders:Object.keys(this.audio_codecs)}}_get_keymap_caps(){return{layout:this.key_layout,keycodes:this._get_keycodes()}}_get_clipboard_caps(){var selections,target;navigator.clipboard&&navigator.clipboard.readText&&navigator.clipboard.writeText?(selections=["CLIPBOARD"],this.log("using new navigator.clipboard")):(selections=["CLIPBOARD","PRIMARY"],this.log("legacy clipboard")),this.log("clipboard polling: ",this.clipboard_poll),this.clipboard_targets=[this.clipboard_preferred_format];for(target of[TEXT_HTML,UTF8_STRING,"TEXT","STRING",TEXT_PLAIN])target!=this.clipboard_preferred_format&&this.clipboard_targets.push(target);return CLIPBOARD_IMAGES&&navigator.clipboard&&Object.hasOwn(navigator.clipboard,"write")?this.clipboard_targets.push("image/png"):this.log("no clipboard write support: no images, navigator.clipboard=",navigator.clipboard),this.log("clipboard targets: ",this.clipboard_targets),this.log("clipboard preferred format: ",this.clipboard_preferred_format),{enabled:this.clipboard_enabled,want_targets:!0,greedy:!0,selections:selections,"preferred-targets":this.clipboard_targets}}_get_encoding_caps(){return this.encoding_options}on_first_ui_event(){}_new_ui_event(){0==this.ui_events&&this.on_first_ui_event(),this.ui_events++}getMouse(e){var windowIsLocked=Boolean(document.pointerLockElement),mx=e.clientX+jQuery(document).scrollLeft(),my=e.clientY+jQuery(document).scrollTop(),windowIsLocked=(windowIsLocked&&(mx=e.movementX,my=e.movementY),1!==this.scale&&(mx=Math.round(mx*this.scale),my=Math.round(my*this.scale)),isNaN(mx)||isNaN(my)?my=isNaN(this.last_mouse_x)||isNaN(this.last_mouse_y)?mx=0:(mx=this.last_mouse_x,this.last_mouse_y):(windowIsLocked&&(this.last_mouse_x+=mx,this.last_mouse_y+=my),this.last_mouse_x=mx,this.last_mouse_y=my),0);return"which"in e?windowIsLocked=Math.max(0,e.which):"button"in e&&(windowIsLocked=Math.max(0,e.button)+1),{x:mx=this.last_mouse_x,y:my=this.last_mouse_y,button:windowIsLocked}}on_mousedown(e,win){return this.mousedown_event=e,this.do_window_mouse_click(e,win,!0),null==win}on_mouseup(e,win){return this.do_window_mouse_click(e,win,!1),null==win}on_mousemove(e,win){var mouse,modifiers,x,y;return!!this.mouse_grabbed||(this.server_readonly||!this.connected?null==window:(mouse=this.getMouse(e),x=Math.round(mouse.x),y=Math.round(mouse.y),modifiers=this._keyb_get_modifiers(e),x=[x,y],y=0,this.server_is_desktop&&(y=1),win&&(y=win.wid,x.push(Math.round(mouse.x-win.x)),x.push(Math.round(mouse.y-win.y)),e.preventDefault()),this.send([PACKET_TYPES.pointer_position,y,x,modifiers,[]]),null==win))}release_buttons(e,win){var button,mouse=this.getMouse(e),x=Math.round(mouse.x),y=Math.round(mouse.y),modifiers=this._keyb_get_modifiers(e),coords=[x,y],wid=0;win&&(wid=win.wid,coords.push(Math.round(mouse.x-win.x)),coords.push(Math.round(mouse.y-win.y)));for(button of this.buttons_pressed)this.send_button_action(wid,button,!1,coords,modifiers)}do_window_mouse_click(e,win,pressed){var send_delay,mouse,x,y,modifiers,coords,wid,button;win&&e.preventDefault(),this.server_readonly||this.mouse_grabbed||!this.connected||($(e.target).attr("id")===FLOAT_MENU_SELECTOR.slice(1)||0<$(e.target).parents(FLOAT_MENU_SELECTOR).length?this.debug("clicked on float_menu, skipping event handler",e):(send_delay=0,"to-server"!==client.clipboard_direction&&this._poll_clipboard(e)&&(send_delay=CLIPBOARD_EVENT_DELAY),mouse=this.getMouse(e,win),x=Math.round(mouse.x),y=Math.round(mouse.y),modifiers=this._keyb_get_modifiers(e),coords=[x,y],wid=0,win&&(wid=win.wid,coords.push(Math.round(mouse.x-win.x)),coords.push(Math.round(mouse.y-win.y)),e.preventDefault()),0<wid&&this.focus!=wid&&this.set_focus(win),window.cursor_lock&&($("#cursor-lock-button").removeClass("icon-paused"),win.canvas.requestPointerLock()),button=mouse.button,(e=this.last_button_event)[0]==button&&e[1]==pressed&&e[2]==x&&e[3]==y?this.debug("mouse","skipping duplicate click event"):(this.last_button_event=[button,pressed,x,y],this.debug("mouse","click:",button,pressed,x,y),4==button?button=8:5==button&&(button=9),setTimeout(()=>{this.clipboard_delayed_event_time=performance.now()+CLIPBOARD_EVENT_DELAY,this.send_button_action(wid,button,pressed,coords,modifiers)},send_delay))))}send_button_action(wid,button,pressed,coords,modifiers){pressed?this.buttons_pressed.add(button):this.buttons_pressed.delete(button),this.send([PACKET_TYPES.button_action,wid,button,pressed,coords,modifiers,[]])}detect_vertical_scroll_direction(e){var delta;return!e||(delta=null,e.wheelDelta?delta=e.wheelDelta:e.detail&&(delta=-e.detail),null==delta)?0:0<delta?-1:delta<0?1:0}on_mousescroll(e,win){if(this.server_readonly||this.mouse_grabbed||!this.connected)return!1;var mouse=this.getMouse(e),x=Math.round(mouse.x),y=Math.round(mouse.y),modifiers=this._keyb_get_modifiers(e),buttons=[],wid=0,mouse=(win&&(wid=win.wid),Utilities.normalizeWheel(e)),win=(this.debug("mouse","normalized wheel event:",mouse),Math.min(1200,mouse.pixelX)),mouse=Math.min(1200,mouse.pixelY),apx=(this.scroll_reverse_x&&(win=-win),(1==this.scroll_reverse_y||"auto"==this.scroll_reverse_x&&this.detect_vertical_scroll_direction(e)<0&&0<mouse)&&(mouse=-mouse),Math.abs(win)),apy=Math.abs(mouse);if(!this.server_precise_wheel){40<=apx&&apx<=160?this.wheel_delta_x=0<win?120:-120:this.wheel_delta_x+=win,40<=apy&&apy<=160?this.wheel_delta_y=0<mouse?120:-120:this.wheel_delta_y+=mouse;for(var wx=Math.abs(this.wheel_delta_x),wy=Math.abs(this.wheel_delta_y),button_x=0<=this.wheel_delta_x?7:6,button_y=0<=this.wheel_delta_y?5:4;120<=wx;)wx-=120,this.send([PACKET_TYPES.button_action,wid,button_x,!0,[x,y],modifiers,buttons]),this.send([PACKET_TYPES.button_action,wid,button_x,!1,[x,y],modifiers,buttons]);for(;120<=wy;)wy-=120,this.send([PACKET_TYPES.button_action,wid,button_y,!0,[x,y],modifiers,buttons]),this.send([PACKET_TYPES.button_action,wid,button_y,!1,[x,y],modifiers,buttons]);return this.wheel_delta_x=0<=this.wheel_delta_x?wx:-wx,this.wheel_delta_y=0<=this.wheel_delta_y?wy:-wy,e.preventDefault(),!1}0<apx&&(button_x=0<=win?7:6,e=Math.round(1e3*win/120),this.send([PACKET_TYPES.wheel_motion,wid,button_x,-e,[x,y],modifiers,buttons])),0<apy&&(button_y=0<=mouse?5:4,apx=Math.round(1e3*mouse/120),this.send([PACKET_TYPES.wheel_motion,wid,button_y,-apx,[x,y],modifiers,buttons]))}init_clipboard(){this.clog("initializing clipboard: enabled=",this.clipboard_enabled,", poll=",this.clipboard_poll,", preferred format=",this.clipboard_preferred_format),this.clipboard_enabled&&(window.addEventListener("paste",e=>{var clipboardData=(e.originalEvent||e).clipboardData;if(clipboardData&&clipboardData.files&&0<clipboardData.files.length){var files=clipboardData.files;this.clog("paste got",files.length,"files");for(var index=0;index<files.length;index++){var file=files.item(index);this.send_file(file)}e.preventDefault()}else{e=this.clipboard_preferred_format;(e==TEXT_PLAIN||e==UTF8_STRING)&&navigator.clipboard&&navigator.clipboard.readText?navigator.clipboard.readText().then(text=>{this.cdebug("clipboard","paste event, text=",text),this.clipboard_buffer=text;text=Utilities.StringToUint8(text);this.send_clipboard_token(text)},error=>this.cdebug("clipboard","paste event failed:",error)):(clipboardData=clipboardData.getData(e))&&(this.cdebug("clipboard","paste event, ",e,"=",clipboardData),this.clipboard_buffer=clipboardData,clipboardData=Utilities.StringToUint8(clipboardData),this.send_clipboard_token(clipboardData,[e]))}}),window.addEventListener("copy",e=>{var clipboard_buffer=this.get_clipboard_buffer(),pasteboard=$(PASTEBOARD_SELECTOR);pasteboard.text(clipboard_buffer),pasteboard.select(),this.cdebug("clipboard","copy event, clipboard buffer=",clipboard_buffer),this.clipboard_pending=!1}),window.addEventListener("cut",e=>{var clipboard_buffer=this.get_clipboard_buffer(),pasteboard=$(PASTEBOARD_SELECTOR);pasteboard.text(clipboard_buffer),pasteboard.select(),this.cdebug("clipboard","cut event, clipboard buffer=",clipboard_buffer),this.clipboard_pending=!1}),$("#screen").on("click",e=>this.may_set_clipboard()),$("#screen").keypress(()=>this.may_set_clipboard()))}may_set_clipboard(e){if(this.cdebug("clipboard","pending=",this.clipboard_pending,"buffer=",truncate(this.clipboard_buffer)),this.clipboard_pending){var clipboard_buffer=this.get_clipboard_buffer(),clipboard_datatype=(this.get_clipboard_datatype()||"").toLowerCase(),is_text=clipboard_datatype.includes("text")||clipboard_datatype.includes("string"),pasteboard=(is_text||(clipboard_buffer=""),$(PASTEBOARD_SELECTOR)),pasteboard=(pasteboard.text(clipboard_buffer),pasteboard.select(),this.cdebug("clipboard","click event, with pending clipboard datatype=",clipboard_datatype,", buffer=",clipboard_buffer),!1);if(Object.hasOwn(window,"clipboardData")&&Object.hasOwn(window.clipboardData,"setData")&&"function"==typeof window.clipboardData.setData)try{window.clipboardData.setData(clipboard_datatype,clipboard_buffer),pasteboard=!0}catch{pasteboard=!1}(pasteboard=!pasteboard&&is_text?document.execCommand("copy"):pasteboard)&&(this.clipboard_buffer=clipboard_buffer,this.clipboard_pending=!1)}}_poll_clipboard(e){if(this.clipboard_poll)return!this.clipboard_pending&&void this.read_clipboard(e)}read_clipboard(e){var datatype;if(!1!==this.clipboard_enabled)return navigator.clipboard&&navigator.clipboard.clipboardData?(this.debug("clipboard","polling using",navigator.clipboard.clipboardData),this.read_clipboard_data(),!1):navigator.clipboard&&navigator.clipboard.readText?(this.debug("clipboard","polling using",navigator.clipboard.readText),this.read_clipboard_text(),!1):(datatype=TEXT_PLAIN,(e=(e.originalEvent||e).clipboardData)?null!==(e=e.getData(datatype))&&(e=unescape(encodeURIComponent(e)),this.debug("clipboard","paste event, data=",e),e!=this.clipboard_buffer)&&(this.debug("clipboard","clipboard contents have changed"),this.clipboard_buffer=e,this.send_clipboard_token(e,[datatype]),this.clipboard_delayed_event_time=performance.now()+CLIPBOARD_EVENT_DELAY,!0):(this.debug("clipboard","polling: no data available"),!1))}read_clipboard_data(){!1!==this.clipboard_enabled&&navigator.clipboard.clipboardData.read(TEXT_HTML).then(text=>{this.debug("clipboard","paste event, text/html=",text),text?((text=text)!=this.clipboard_buffer&&(this.debug("clipboard","clipboard contents have changed"),this.clipboard_buffer=text,this.send_clipboard_token(text,[TEXT_HTML]),this.clipboard_delayed_event_time=performance.now()+CLIPBOARD_EVENT_DELAY),this.clipboard_pending=!1):read_clipboard_text()},error=>{this.debug("clipboard","paste event failed:",error),this.clipboard_pending=!1})}read_clipboard_text(){!1!==this.clipboard_enabled&&(client.debug("clipboard","read_clipboard_text()"),navigator.clipboard.readText().then(text=>{this.debug("clipboard","paste event, text=",text);text=unescape(encodeURIComponent(text));text!=this.clipboard_buffer&&(this.debug("clipboard","clipboard contents have changed"),this.clipboard_buffer=text,this.send_clipboard_token(text),this.clipboard_delayed_event_time=performance.now()+CLIPBOARD_EVENT_DELAY),this.clipboard_pending=!1},error=>{this.debug("clipboard","paste event failed:",error),this.clipboard_pending=!1}))}set_focus(win){if(null!=win&&!this.server_readonly&&this.connected&&!win.override_redirect&&!win.tray){win.minimized&&win.toggle_minimized();var modal=!1;if(MODAL_FOCUS)for(var index in this.id_to_window)modal=modal||this.id_to_window[index].metadata.modal;if(!modal||win.metadata.modal){var wid=win.wid;if(this.focus!=wid){if(void 0!==default_settings&&void 0!==default_settings.auto_fullscreen_desktop_class&&0<default_settings.auto_fullscreen_desktop_class.length){var auto_fullscreen_desktop_class=default_settings.auto_fullscreen_desktop_class;if("DESKTOP"==win.windowtype&&win.metadata["class-instance"].includes(auto_fullscreen_desktop_class))for(var index in this.id_to_window){var otherwin=this.id_to_window[index];if(otherwin.wid!=win.wid&&!otherwin.minimized)return}}var top_stacking_layer=Object.keys(this.id_to_window).length,old_stacking_layer=win.stacking_layer,had_focus=this.focus,iwin=(this.focus=wid,this.topwindow=wid,this.send([PACKET_TYPES.focus,wid,[]]),null);for(index in this.id_to_window)(iwin=this.id_to_window[index]).focused=iwin.wid==wid,iwin.focused?(iwin.stacking_layer=top_stacking_layer,this.send_configure_window(iwin,{focused:!0},!0)):(iwin.stacking_layer>old_stacking_layer&&iwin.stacking_layer--,had_focus==index&&this.send_configure_window(iwin,{focused:!1},!0)),iwin.updateFocus(),iwin.update_zindex()}}}}is_window_desktop(win){if(void 0!==default_settings&&void 0!==default_settings.auto_fullscreen_desktop_class&&0<default_settings.auto_fullscreen_desktop_class.length){var auto_fullscreen_desktop_class=default_settings.auto_fullscreen_desktop_class;if("DESKTOP"==win.windowtype&&win.metadata["class-instance"].includes(auto_fullscreen_desktop_class))return!0}return!1}toggle_window_preview(init_callback){var preview_element=$(WINDOW_PREVIEW_SELECTOR);if(preview_element.on("init",(e,slick)=>{init_callback&&init_callback(e,slick)}),preview_element.on("afterChange",(event,slick,currentSlide)=>{var wid=$(".slick-current .window-preview-item-container").data("wid"),wid=this.id_to_window[wid];wid.minimized||wid.focus()}),$(window).on("click",this._handle_window_list_blur),$(window).on("contextmenu",this._handle_window_list_blur),preview_element.is(":visible"))wid=$(".slick-current .window-preview-item-container").data("wid"),this.clog("current wid: "+wid),(win=this.id_to_window[wid]).minimized&&win.focus(),preview_element.children().remove(),preview_element.slick("unslick"),preview_element.children().remove(),preview_element.hide(),preview_element.off("afterChange"),preview_element.off("init"),$(window).off("click",this._handle_window_list_blur),$(window).off("contextmenu",this._handle_window_list_blur);else{preview_element.children().remove();var windows_sorted=Object.values(client.id_to_window).filter(win=>!client.is_window_desktop(win));if(0!==windows_sorted.length){var index,wid=200*Math.min(4,windows_sorted.length);for(index in preview_element.css("width",wid+"px"),windows_sorted.sort((a,b)=>a.stacking_layer<b.stacking_layer?1:a.stacking_layer>b.stacking_layer?-1:0),windows_sorted){var win=windows_sorted[index],item_container=$("<div>"),item_text_element=(item_container.data("wid",win.wid),item_container.addClass("window-preview-item-container"),$("<div>")),png_base64=(item_text_element.addClass("window-preview-item-text"),item_text_element.text(win.title),win.canvas.toDataURL("image/png")),img_element=$("<img>");img_element.addClass("window-preview-item-img"),img_element.attr("src",png_base64),item_container.append(item_text_element),item_container.append(img_element),preview_element.append(item_container)}preview_element.show(),preview_element.slick({centerMode:!0,focusOnSelect:!0,focusOnChange:!0,touchMove:!1,centerPadding:"0px",slidesToShow:Math.max(1,Math.min(4,windows_sorted.length)),slidesToScroll:1,infinite:!0,adaptiveHeight:!1,speed:0,prevArrow:null,nextArrow:null,easing:"null",waitForAnimate:!1})}}}_handle_window_list_blur(e){!$(WINDOW_PREVIEW_SELECTOR).is(":visible")||e.target.id===WINDOW_PREVIEW_SELECTOR.slice(1)||0<$(e.target).parents(WINDOW_PREVIEW_SELECTOR).length||$(e.target).hasClass("window-list-button")||0<$(e.target).parents(FLOAT_MENU_SELECTOR).length&&$(e.target).parent().has("#open_windows_list")||client.toggle_window_preview()}on_open(){}_process_open(){this.cancel_open_timer(),this.on_connection_progress("WebSocket connection established","",80),this._send_hello(),this.on_open()}schedule_open_timer(){this.cancel_open_timer(),this.open_timer=setTimeout(()=>{this.reconnect||this.reconnect_attempt<this.reconnect_count?(this.close_protocol(),this.reconnect_attempt++,this.do_reconnect()):(this.disconnect_reason="failed to open connection",this.close())},this.OPEN_TIMEOUT)}cancel_open_timer(){this.open_timer&&(clearTimeout(this.open_timer),this.open_timer=null)}schedule_hello_timer(){this.cancel_hello_timer(),this.hello_timer=setTimeout(()=>{this.disconnect_reason="Did not receive hello before timeout reached, not an Xpra server?",this.close()},this.HELLO_TIMEOUT)}cancel_hello_timer(){this.hello_timer&&(clearTimeout(this.hello_timer),this.hello_timer=null)}_process_error(packet){var code=Number.parseInt(packet[2]),reconnect=this.reconnect||this.reconnect_attempt<this.reconnect_count;reconnect&&[0,1006,1008,1010,1014,1015].includes(code)&&(reconnect=this.connected),this.cerror("websocket error: ",packet[1],"code: ",code,"reason: ",this.disconnect_reason,", connected: ",this.connected,", reconnect: ",reconnect),this.reconnect_in_progress||(this.packet_disconnect_reason(packet),this.close_audio(),reconnect)||this.close()}packet_disconnect_reason(packet){if(!this.disconnect_reason&&packet[1]){var code=packet[2];if(!this.connected&&[0,1006,1008,1010,1014,1015].includes(code))this.disconnect_reason="connection failed, invalid address?";else{this.disconnect_reason=packet[1];for(var index=2;packet.length>index&&packet[index];)this.disconnect_reason+=`
`+packet[index],index++}}}do_reconnect(){this.reconnect_in_progress=!0,setTimeout(()=>{try{this.remove_windows(),this.close_audio(),this.cancel_all_files(),this.clear_timers(),this.init_state(),this.close_protocol(),this.emit_connection_lost(),this.connect()}finally{this.reconnect_in_progress=!1}},this.reconnect_delay)}_process_close(packet){this.clog("websocket closed: ",packet[1],"reason: ",this.disconnect_reason,", reconnect: ",this.reconnect,", reconnect attempt: ",this.reconnect_attempt),this.reconnect_in_progress||(this.packet_disconnect_reason(packet),this.reconnect&&this.reconnect_attempt<this.reconnect_count?(this.emit_connection_lost(),this.close_protocol(),this.reconnect_attempt++,this.do_reconnect()):this.close())}disconnect(reason){this.disconnect_reason=reason||"unknown",this.close()}close(){this.reconnect_in_progress||(this.clog("client closed"),this.cancel_open_timer(),this.cancel_hello_timer(),this.cancel_all_files(),this.emit_connection_lost(),this.remove_windows(),this.close_audio(),this.clear_timers(),this.close_protocol(),this.callback_close(this.disconnect_reason))}_process_disconnect(packet){this.debug("main","disconnect reason:",packet[1]),this.reconnect_in_progress||(this.packet_disconnect_reason(packet),this.close(),this.callback_close(this.disconnect_reason))}_process_startup_complete(packet){this.log("startup complete"),this.emit_connection_established()}_connection_change(e){var ci=Utilities.getConnectionInfo();this.clog("connection status - change event=",e,", connection info=",ci,"tell server:",this.server_connection_data),ci&&this.server_connection_data&&this.send([PACKET_TYPES.connection_data,ci])}_process_hello(packet){this.cancel_open_timer(),this.cancel_hello_timer();packet=packet[1];if(this.clog("received hello capabilities",packet),!packet.rencodeplus)throw"no common packet encoders, 'rencodeplus' is required by this client";this.session_name=packet.session_name,$("title").text(this.session_name),this.server_display=packet.display||"",this.server_platform=packet.platform||"",this.server_remote_logging=packet["remote-logging.multi-line"],this.server_remote_logging&&this.remote_logging&&(Utilities.log=()=>this.log(arguments),Utilities.warn=()=>this.warn(arguments),Utilities.error=()=>this.error(arguments),Utilities.exc=()=>this.exc(arguments)),this.encryption&&(this.cipher_out_caps=packet.encryption,console.info("cipher out caps=",JSON.stringify(this.cipher_out_caps)),this.protocol.set_cipher_out(this.cipher_out_caps,this.encryption_key));var version=Utilities.s(packet.version);try{var vno=version.split(".").map(x=>Number.parseInt(x));if(vno[0]<=0&&vno[1]<10)return this.disconnect("unsupported version: "+version),void this.close()}catch{return this.disconnect(`error parsing version number '${version}'`),void this.close()}this.log("got hello: server version",version,"accepted our connection"),this._process_modifier_keycodes(packet.modifier_keycodes||{}),this._process_audio_caps(packet.audio||{}),SHOW_START_MENU&&(this.xdg_menu=packet["xdg-menu"],this.xdg_menu)&&this.process_xdg_menu(),packet["client-shutdown"]||$("#shutdown_menu_entry").hide(),this.file_transfer&&(packet["file-transfer"]||packet.file&&packet.file.enabled)||($("#upload_menu_entry").hide(),$("#download_menu_entry").hide()),this.server_is_desktop=Boolean(packet.desktop),this.server_is_shadow=Boolean(packet.shadow),this.server_readonly=Boolean(packet.readonly),(this.server_is_desktop||this.server_is_shadow)&&jQuery("body").addClass("desktop"),this.server_resize_exact=packet.resize_exact||!1,this.server_screen_sizes=packet["screen-sizes"]||[],this.clog("server screen sizes:",this.server_screen_sizes),this.server_precise_wheel=packet["wheel.precise"]||!1,this.remote_open_files=Boolean(packet["open-files"]),this.remote_file_transfer=Boolean(packet["file-transfer"]),this.remote_printing=Boolean(packet.printing),this.remote_printing&&this.printing&&this.send([PACKET_TYPES.printers,{"HTML5 client":{"printer-info":"Print to PDF in client browser","printer-make-and-model":"HTML5 client version",mimetypes:["application/pdf"]}}]),this.server_connection_data=packet["connection-data"],Object.hasOwn((navigator,"connection"))&&(navigator.connection.addEventListener("change",this._connection_change),this._connection_change()),this.clipboard_enabled=Boolean(packet.clipboard||!1),this.remote_file_size_limit=packet["max-file-size"],this.remote_file_chunks=Math.max(0,Math.min(this.remote_file_size_limit,packet["file-chunks"]||0)),this._send_ping(),this.ping_timer=setInterval(()=>this._send_ping(),this.PING_FREQUENCY),this.reconnect_attempt=0,this.start_new_session=null,this.on_connection_progress("Session started","",100),this.on_connect(),this.connected=!0}_process_modifier_keycodes(modifier_keycodes){if(modifier_keycodes)for(var modifier in modifier_keycodes)if(Object.hasOwn(modifier_keycodes,modifier)){var keycode,mappings=modifier_keycodes[modifier];for(keycode in mappings){var index,keys=mappings[keycode];for(index in keys){var key=keys[index];"Num_Lock"==key?this.num_lock_modifier=modifier:"Alt_L"==key?this.alt_modifier=modifier:"Meta_L"==key?this.meta_modifier=modifier:"ISO_Level3_Shift"==key||"Mode_switch"==key?this.altgr_modifier=modifier:"Control_L"==key&&(this.control_modifier=modifier)}}}}_process_audio_caps(audio_caps){if(this.audio_enabled)if(audio_caps.send)if(this.server_audio_codecs=audio_caps.encoders,this.server_audio_codecs){if(this.log("audio codecs supported by the server:",this.server_audio_codecs),!this.server_audio_codecs.includes(this.audio_codec)){this.warn(`audio codec ${this.audio_codec} is not supported by the server`),this.audio_codec=null;for(var codec of MediaSourceConstants.PREFERRED_CODEC_ORDER)if(codec in this.audio_codecs&&this.server_audio_codecs.includes(codec)){this.audio_framework=this.mediasource_codecs[codec]?"mediasource":"aurora",this.audio_codec=codec,this.log("using",this.audio_framework,"audio codec",codec);break}if(!this.audio_codec)return this.audio_enabled=!1,void this.on_audio_state_change("disabled","no matching audio codec")}this.audio_enabled&&!Utilities.isFirefox()&&this._sound_start_receiving()}else this.audio_enabled=!1,this.on_audio_state_change("disabled","audio codecs missing on the server");else this.audio_enabled=!1,this.on_audio_state_change("disabled","server does not support speaker forwarding");else this.on_audio_state_change("disabled","")}_process_encodings(packet){packet=packet[1];this.log("update encodings:",Object.keys(packet))}process_xdg_menu(){this.log("received xdg start menu data"),$("#startmenu li").remove();var key,startmenu=document.querySelector("#startmenu");for(key in this.xdg_menu){var category=this.xdg_menu[key],li=document.createElement("li"),catDivLeft=(li.className="-hasSubmenu",document.createElement("div")),a=(catDivLeft.className="menu-divleft",catDivLeft.append(this.xdg_image(category.IconData,category.IconType)),document.createElement("a")),ul=(a.append(catDivLeft),a.append(document.createTextNode(this.xdg_menu[key].Name)),a.href="#",li.append(a),document.createElement("ul")),xdg_menu_cats=(a.addEventListener("mouseenter",function(){this.parentElement.childNodes[1].className="-visible"}),a.addEventListener("mouseleave",function(){this.parentElement.childNodes[1].className=""}),category.Entries);for(key in xdg_menu_cats){var entry=xdg_menu_cats[key],li2=document.createElement("li"),a2=document.createElement("a"),name=entry.Name,name=Utilities.trimString(name,15),command=entry.Exec.replace(/%[FUfu]/g,""),divLeft=document.createElement("div"),entry=(divLeft.className="menu-divleft",divLeft.append(this.xdg_image(entry.IconData,entry.IconType)),document.createElement("div")),me=(entry.append(document.createTextNode(name)),entry.className="menu-content-left",divLeft.append(entry),a2.append(divLeft),a2.title=command,this);a2.addEventListener("click",function(){me.start_command(this.innerText,this.title,"False"),document.querySelector("#menu_list").className="-hide"}),a2.addEventListener("mouseenter",function(){this.parentElement.parentElement.className="-visible"}),a2.addEventListener("mouseleave",function(){this.parentElement.parentElement.className=""}),li2.append(a2),ul.append(li2)}li.append(ul),startmenu.append(li)}0===this.xdg_menu.length&&startmenu.css("box-shadow","none")}_process_setting_change(packet){var setting=packet[1],packet=packet[2];"xdg-menu"==setting&&SHOW_START_MENU?(this.xdg_menu=packet,this.xdg_menu&&(this.process_xdg_menu(),$("#startmenuentry").show())):"session_name"==setting&&(this.session_name=packet,jQuery("title").text(packet))}xdg_image(icon_data,icon_type){var img=new Image;return void 0!==icon_data&&(img.src="data:"+("svg"==icon_type?"image/svg+xml":"image/"+icon_type)+";base64,"+Utilities.ArrayBufferToBase64(icon_data)),img.className="menu-content-left",img.height=24,img.width=24,img}on_connect(){}_process_challenge(packet){if(this.cancel_open_timer(),this.cancel_hello_timer(),this.encryption){if(!(3<=packet.length))return void this.disconnect("challenge does not contain encryption details to use for the response");this.cipher_out_caps=packet[2],this.protocol.set_cipher_out(this.cipher_out_caps,this.encryption_key)}var address,digest=packet[3],server_salt=Uint8ToString(packet[1]),salt_digest=packet[4]||"xor",packet=(packet[5]||"password").replace(/[^\d+,. /:a-z]/gi,""),client=(this.clog("process challenge:",digest),this);function call_do_process_challenge(password){client&&client.protocol&&(null==password?client.disconnect("password prompt cancelled"):client.do_process_challenge(digest,server_salt,salt_digest,password))}return 0<this.passwords.length?this.is_digest_safe(digest)?void call_do_process_challenge(this.passwords.shift()):void this.disconnect("refusing to send a password over an insecure connection"):digest.startsWith("keycloak")&&this.keycloak_prompt_fn?void this.keycloak_prompt_fn(server_salt,call_do_process_challenge):this.password_prompt_fn&&this.is_digest_safe(digest)?this.is_digest_safe(digest)?(address=client.host+":"+client.port,void this.password_prompt_fn(`The server at ${address} requires a `+packet,call_do_process_challenge)):void this.disconnect("refusing to prompt for a password over an insecure connection"):void this.disconnect("No password specified for authentication challenge")}is_digest_safe(digest){return"xor"!=digest||this.ssl||this.encryption||this.insecure||Utilities.isSafeHost(this.host)}do_process_challenge(digest,server_salt,salt_digest,password){var l=server_salt.length;if(this.is_digest_safe(digest)){if("xor"==salt_digest){if(l<16||256<l)return void this.disconnect("invalid server salt length for xor digest:"+l)}else l=32;var challenge_digest=digest.startsWith("keycloak")?"xor":digest,client_salt=Utilities.getSecureRandomString(l);this.clog("combining client salt:",Utilities.convertToHex(client_salt)),this.clog("with server salt:",Utilities.convertToHex(server_salt)),this.clog("using",salt_digest),Utilities.gendigest(salt_digest,client_salt,server_salt).then(salt=>{this.clog(salt_digest,":",Utilities.convertToHex(salt));salt=Utilities.convertToHex(salt);Utilities.gendigest(challenge_digest,password,salt).then(challenge_response=>{challenge_response=Utilities.convertToHex(challenge_response);this.do_send_hello(challenge_response,client_salt)}).catch(err=>this.disconnect("failed to generate challenge response: "+err))}).catch(err=>this.disconnect("failed to generate salt: "+err))}else this.disconnect("server requested digest xor, cowardly refusing to use it without encryption with "+this.host)}_send_ping(){var now_ms;!this.reconnect_in_progress&&this.connected&&(now_ms=Math.ceil(performance.now()),this.send([PACKET_TYPES.ping,now_ms]),this.ping_timeout_timer=setTimeout(()=>this._check_echo_timeout(now_ms),this.PING_TIMEOUT),this.ping_grace_timer=setTimeout(()=>this._check_server_echo(now_ms),2e3))}_process_ping(packet){var echotime=packet[1],sid=(this.last_ping_server_time=echotime,2<packet.length&&(this.last_ping_server_time=packet[2]),"");4<=packet.length&&(sid=packet[3]),this.last_ping_local_time=Date.now();this.send([PACKET_TYPES.ping_echo,echotime,0,0,0,0,sid])}_process_ping_echo(packet){this.last_ping_echoed_time=packet[1];var l1=packet[2],l2=packet[3],l3=packet[4];this.client_ping_latency=packet[5],this.server_ping_latency=Math.ceil(performance.now())-this.last_ping_echoed_time,this.server_load=[l1/1e3,l2/1e3,l3/1e3],this._check_server_echo(0)}start_info_timer(){null==this.info_timer&&(this.info_timer=setInterval(()=>{null!=this.info_timer&&this.send_info_request()},this.INFO_FREQUENCY))}send_info_request(){this.info_request_pending||(this.send([PACKET_TYPES.info_request,[this.uuid],[],[]]),this.info_request_pending=!0)}_process_info_response(packet){this.info_request_pending=!1,this.server_last_info=packet[1],this.debug("network","info-response:",this.server_last_info);packet=document.createEvent("Event");packet.initEvent("info-response",!0,!0),packet.data=this.server_last_info,document.dispatchEvent(packet)}stop_info_timer(){this.info_timer&&(clearTimeout(this.info_timer),this.info_timer=null,this.info_request_pending=!1)}position_float_menu(){var float_menu_element=$(FLOAT_MENU_SELECTOR),toolbar_height=float_menu_element.height(),toolbar_width=float_menu_element.width(),left=float_menu_element.offset().left||0,top=float_menu_element.offset().top||0,screen_width=$("#screen").width(),screen_height=$("#screen").height();"custom"!=this.toolbar_position&&("top-left"==this.toolbar_position?top=left=0:"top"==this.toolbar_position?left=screen_width/2-toolbar_width/2:"top-right"==this.toolbar_position?left=screen_width-toolbar_width-100:"novnc"==this.toolbar_position&&(left=0,top=screen_height/2-toolbar_height/2-100)),float_menu_element.offset({top:top,left:left})}_process_new_tray(packet){var wid=packet[1],packet=packet[4],mydiv=document.createElement("div"),mycanvas=(mydiv.id=String(wid),document.createElement("canvas")),float_tray=(mydiv.append(mycanvas),document.querySelector("#float_tray")),float_menu=document.querySelector(FLOAT_MENU_SELECTOR),float_menu_element=$(FLOAT_MENU_SELECTOR),new_width=(float_menu_element.children().show(),float_menu_width+float_menu_item_size-float_menu_padding+5),float_menu=(float_menu.style.width=new_width+"px",float_menu_width=float_menu_element.width()+10,mydiv.style.backgroundColor="white",float_tray.append(mydiv),float_menu_item_size),new_width=float_menu_item_size;mycanvas.width=float_menu,mycanvas.height=new_width,this.id_to_window[wid]=new XpraWindow(this,wid,0,0,float_menu,new_width,packet,!1,!0,{},()=>this.debug("tray","tray geometry changed (ignored)"),(event,window)=>this.on_mousemove(event,window),(event,window)=>this.on_mousedown(event,window),(event,window)=>this.on_mouseup(event,window),(event,window)=>this.on_mousescroll(event,window),()=>this.debug("tray","tray set focus (ignored)"),()=>this.debug("tray","tray closed (ignored)"),this.scale),this.send_tray_configure(wid)}send_tray_configure(wid){var div=jQuery("#"+wid),x=Math.round(div.offset().left),div=Math.round(div.offset().top),w=float_menu_item_size,h=float_menu_item_size;this.clog("tray",wid,"position:",x,div),this.send([PACKET_TYPES.configure_window,Number(wid),x,div,w,h,{}])}reconfigure_all_trays(){var twid,float_menu=document.querySelector(FLOAT_MENU_SELECTOR),float_menu_width=float_menu_item_size*float_menu_item_count+float_menu_padding;for(twid in this.id_to_window){var twin=this.id_to_window[twid];twin&&twin.tray&&(float_menu_width+=float_menu_item_size,this.send_tray_configure(twid))}0<$(FLOAT_MENU_SELECTOR).width()&&(float_menu.style.width=float_menu_width,this.position_float_menu())}suspend(){var index,window_ids=Object.keys(client.id_to_window).map(Number);for(index in this.send([PACKET_TYPES.suspend,!0,window_ids]),this.id_to_window)this.id_to_window[index].suspend()}resume(){var index,window_ids=Object.keys(client.id_to_window).map(Number);for(index in this.id_to_window)this.id_to_window[index].resume();this.send([PACKET_TYPES.resume,!0,window_ids]),this.redraw_windows(),this.request_refresh(-1)}_new_window(wid,x,y,w,h,metadata,override_redirect,client_properties){var mydiv=document.createElement("div");mydiv.id=String(wid);document.querySelector("#screen").append(mydiv);mydiv=new XpraWindow(this,wid,x,y,w,h,metadata,override_redirect,!1,client_properties,window=>this.send_configure_window(window,{},!1),(event,window)=>this.on_mousemove(event,window),(event,window)=>this.on_mousedown(event,window),(event,window)=>this.on_mouseup(event,window),(event,window)=>this.on_mousescroll(event,window),window=>this.set_focus(window),window=>this.send_close_window(window),this.scale);this.server_is_desktop||this.server_is_shadow?window.noWindowList():mydiv&&mydiv.has_decorations&&(x=Utilities.trimString(mydiv.title,30),window.addWindowListItem(mydiv,wid,x)),this.id_to_window[wid]=mydiv,override_redirect||(y=mydiv.get_internal_geometry(),this.send([PACKET_TYPES.map_window,wid,y.x,y.y,y.w,y.h,mydiv.client_properties]),this.set_focus(mydiv))}_new_window_common(packet,override_redirect){var wid=packet[1],x=packet[2],y=packet[3],w=packet[4],h=packet[5],metadata=packet[6];if(wid in this.id_to_window)throw new Error("we already have a window "+wid);(w<=0||h<=0)&&(this.error("window dimensions are wrong:",w,h),h=w=1);var client_properties={};8<=packet.length&&(client_properties=packet[7]),0!=x||0!=y||metadata["set-initial-position"]||metadata.fullscreen||(0==(packet=Object.keys(this.id_to_window).length)?(w<=this.desktop_width&&(x=Math.round((this.desktop_width-w)/2)),h<=this.desktop_height&&(y=Math.round((this.desktop_height-h)/2))):(x=Math.min(10*packet,Math.max(0,this.desktop_width-100)),y=96)),this._new_window(wid,x,y,w,h,metadata,override_redirect,client_properties),this._new_ui_event()}send_configure_window(win,state,skip_geometry){var geom=win.get_internal_geometry(),wid=win.wid,wid=[PACKET_TYPES.configure_window,wid,geom.x,geom.y,geom.w,geom.h,win.client_properties,0,state,skip_geometry];this.send(wid)}_process_new_window(packet){this._new_window_common(packet,!1)}_process_new_override_redirect(packet){this._new_window_common(packet,!0)}_process_window_metadata(packet){var wid=packet[1],packet=packet[2],wid=this.id_to_window[wid];null!=wid&&wid.update_metadata(packet)}_process_initiate_moveresize(packet){var x_root,y_root,direction,button,wid=packet[1],win=this.id_to_window[wid];win?(x_root=packet[2],y_root=packet[3],direction=packet[4],button=packet[5],packet=packet[6],this.log("initiate moveresize on",win,"mousedown_event=",this.mousedown_event),win.initiate_moveresize(this.mousedown_event,x_root,y_root,direction,button,packet)):this.log("cannot initiate moveresize, window",wid,"not found")}_process_pointer_position(packet){var cursor_url,w,h,xhot,yhot,wid=packet[1],x=packet[2],y=packet[3],wid=this.id_to_window[wid],packet=(6<=packet.length&&wid&&(x=wid.x+packet[4],y=wid.y+packet[5]),document.querySelector("#shadow_pointer")),style=packet.style;wid.cursor_data?(cursor_url=wid.cursor_data[0],xhot=wid.cursor_data[1],yhot=wid.cursor_data[2],w=wid.cursor_data[3],h=wid.cursor_data[4]):(h=w=32,xhot=8,yhot=3,cursor_url="icons/default_cursor.png"),x-=xhot,y-=yhot,style.width=w+"px",style.height=h+"px",packet.src=cursor_url,style.left=x+"px",style.top=y+"px",style.display="inline"}on_last_window(){}_process_lost_window(packet){var packet=packet[1],win=this.id_to_window[packet];win&&win.has_decorations&&window.removeWindowListItem(packet);try{delete this.id_to_window[packet]}catch{}null!=win&&(win.destroy(),this.clog("lost window, was tray=",win.tray),win.tray)&&this.reconfigure_all_trays(),this.clog("lost window",packet,", remaining: ",Object.keys(this.id_to_window)),0===Object.keys(this.id_to_window).length?this.on_last_window():win&&win.focused&&this.auto_focus(),this.decode_worker&&this.decode_worker.postMessage({cmd:"remove",wid:packet})}auto_focus(){var highest_window=null,highest_stacking=-1,modal=!1;if(MODAL_FOCUS)for(var index in this.id_to_window)var win=this.id_to_window[index],modal=modal||win.metadata.modal;for(index in this.id_to_window)(win=this.id_to_window[index]).minimized||win.tray||modal&&!win.metadata.modal||win.stacking_layer>highest_stacking&&(highest_stacking=(highest_window=win).stacking_layer);highest_window?this.set_focus(highest_window):(this.focus=0,this.send([PACKET_TYPES.focus,0,[]]))}_process_raise_window(packet){packet=packet[1],packet=this.id_to_window[packet];this.set_focus(packet)}_process_window_resized(packet){var wid=packet[1],width=packet[2],packet=packet[3],wid=this.id_to_window[wid];null!=wid&&wid.resize(width,packet)}_process_window_move_resize(packet){var[,packet,x,y,width,height]=packet;this.id_to_window[packet]?.move_resize(x,y,width,height)}_process_configure_override_redirect(packet){var[,packet,x,y,width,height]=packet;this.id_to_window[packet]?.move_resize(x,y,width,height)}_process_desktop_size(packet){}_process_bell(packet){var oscillator,gainNode,percent=packet[3],pitch=packet[4],packet=packet[5];null!=this.audio_context?(oscillator=this.audio_context.createOscillator(),gainNode=this.audio_context.createGain(),oscillator.connect(gainNode),gainNode.connect(this.audio_context.destination),gainNode.gain.setValueAtTime(percent,this.audio_context.currentTime),oscillator.frequency.setValueAtTime(pitch,this.audio_context.currentTime),oscillator.start(),setTimeout(()=>oscillator.stop(),packet)):new Audio(BELL_SOUND).play()}_process_notify_show(packet){var nid=packet[2],replaces_nid=packet[4],summary=Utilities.s(packet[6]),body=Utilities.s(packet[7]),expire_timeout=packet[8],icon=packet[9],actions=packet[10],packet=packet[11],context=(window.closeNotification&&(0<replaces_nid&&window.closeNotification(replaces_nid),window.closeNotification(nid)),this);function notify(){var icon_url="",icon_url=(icon&&"png"==icon[0]&&(icon_url="data:image/png;base64,"+Utilities.ToBase64(icon[3]),context.clog("notification icon_url=",icon_url)),new Notification(summary,{body:body,icon:icon_url}));icon_url.addEventListener("close",()=>context.send([PACKET_TYPES.notification_close,nid,2,""])),icon_url.addEventListener("click",()=>context.log("user clicked on notification",nid))}if("Notification"in window&&0===actions.length){if("granted"===Notification.permission)return void notify();if("denied"!==Notification.permission)return void Notification.requestPermission(function(permission){"granted"===permission&&notify()})}window.doNotification&&window.doNotification("info",nid,summary,body,expire_timeout,icon,actions,packet,function(nid,action_id){context.send([PACKET_TYPES.notification_action,nid,action_id])},function(nid,reason,text){context.send([PACKET_TYPES.notification_close,nid,reason,text||""])}),context._new_ui_event()}_process_notify_close(packet){packet=packet[1];window.closeNotification&&window.closeNotification(packet)}reset_cursor(){for(var wid in this.id_to_window)this.id_to_window[wid].reset_cursor()}_process_cursor(packet){if(packet.length<9)this.reset_cursor();else{var encoding=packet[1];if("png"!=encoding)this.warn("invalid cursor encoding: "+encoding);else{var wid,w=packet[4],h=packet[5],xhot=packet[6],yhot=packet[7],img_data=packet[9];for(wid in this.id_to_window)this.id_to_window[wid].set_cursor(encoding,w,h,xhot,yhot,img_data)}}}_process_window_icon(packet){var wid=packet[1],w=packet[2],h=packet[3],encoding=packet[4],packet=packet[5],win=(this.debug("main","window-icon: ",encoding," size ",w,"x",h),this.id_to_window[wid]);win&&(win=win.update_icon(w,h,encoding,packet),wid==this.focus||this.server_is_desktop||this.server_is_shadow)&&jQuery("#favicon").attr("href",win)}_process_draw(packet){var coding=Utilities.s(packet[6]),img_data=packet[7],raw_buffers=[],now=performance.now();"scroll"!=coding&&raw_buffers.push(img_data.buffer),this.decode_worker?this.decode_worker.postMessage({cmd:"decode",packet:packet,start:now},raw_buffers):this.do_process_draw(packet,now)}_process_eos(packet){this.do_process_draw(packet,0);packet=packet[1];this.decode_worker&&this.decode_worker.postMessage({cmd:"eos",wid:packet})}request_redraw(win){document.hidden?this.debug("draw","not redrawing, document.hidden=",document.hidden):this.offscreen_api?this.decode_worker.postMessage({cmd:"redraw",wid:win.wid}):(this.debug("draw","request_redraw for",win),win.swap_buffers(),window.requestAnimationFrame?(this.pending_redraw.includes(win)||this.pending_redraw.push(win),this.draw_pending||(this.draw_pending=performance.now(),window.requestAnimationFrame(()=>{this.draw_pending_list()}))):win.draw())}draw_pending_list(){var elapsed=performance.now()-this.draw_pending;for(this.debug("draw","animation frame:",this.pending_redraw.length,"windows to paint, processing delay",elapsed,"ms"),this.draw_pending=0;0<this.pending_redraw.length;)this.pending_redraw.shift().draw()}do_send_damage_sequence(packet_sequence,wid,width,height,decode_time,message){var protocol=this.protocol;protocol&&(packet_sequence=[PACKET_TYPES.damage_sequence,packet_sequence,wid,width,height,decode_time,message],decode_time<0&&this.cwarn("decode error packet:",packet_sequence),protocol.send(packet_sequence))}do_process_draw(packet,start){if(packet){var ptype=packet[0],wid=packet[1],win=this.id_to_window[wid];if("eos"==ptype)this.debug("draw","eos for window",wid),win&&win.eos();else{var width=packet[4],height=packet[5],coding=Utilities.s(packet[6]),packet_sequence=packet[8],options=packet[10]||{};if(this.protocol){var me=this,client=this;if(win)if("offscreen-painted"==coding)send_damage_sequence(options.decode_time||0,"");else try{win.paint(packet,function(error){var flush=options.flush||0,decode_time=Math.round(1e3*performance.now()-1e3*start);0==flush&&client.request_redraw(win),!error&&0!=start||(this.request_redraw(win),decode_time=-1),client.debug("draw","decode time for ",coding," sequence ",packet_sequence,": ",decode_time,", flush=",flush),send_damage_sequence(decode_time,error||"")})}catch(error){this.exc(error,"error painting",coding,"sequence no",packet_sequence),send_damage_sequence(-1,String(error)),win.paint_pending=0,win.may_paint_now(),this.request_redraw(win)}else this.debug("draw","cannot paint, window not found:",wid),send_damage_sequence(-1,`window ${wid} not found`)}}}function send_damage_sequence(decode_time,message){me.do_send_damage_sequence(packet_sequence,wid,width,height,decode_time,message)}}init_audio(ignore_audio_blacklist){if(this.debug("audio","init_audio() enabled=",this.audio_enabled,", mediasource enabled=",this.audio_mediasource_enabled,", aurora enabled=",this.audio_aurora_enabled),this.audio_mediasource_enabled)for(var codec_option in this.mediasource_codecs=MediaSourceUtil.getMediaSourceAudioCodecs(ignore_audio_blacklist),this.mediasource_codecs)this.audio_codecs[codec_option]=this.mediasource_codecs[codec_option];if(this.audio_aurora_enabled)for(var codec_option in this.aurora_codecs=MediaSourceUtil.getAuroraAudioCodecs(),this.aurora_codecs)codec_option in this.audio_codecs||(this.audio_codecs[codec_option]=this.aurora_codecs[codec_option]);this.debug("audio","codecs:",this.audio_codecs),this.audio_codecs?(this.audio_codec in this.audio_codecs?this.log(`using ${this.audio_framework} audio codec: `+this.audio_codec):(this.audio_codec&&(this.warn("invalid audio codec: "+this.audio_codec),this.warn("codecs found: "+this.audio_codecs)),this.audio_codec=MediaSourceUtil.getDefaultAudioCodec(this.audio_codecs),this.audio_codec?(this.audio_mediasource_enabled&&this.audio_codec in this.mediasource_codecs?this.audio_framework="mediasource":this.audio_aurora_enabled&&!Utilities.isIE()&&(this.audio_framework="aurora"),this.audio_framework?this.log(`using ${this.audio_framework} audio codec: `+this.audio_codec):(this.warn("no valid audio framework - cannot enable audio"),this.audio_enabled=!1)):(this.warn("no valid audio codec found"),this.audio_enabled=!1)),this.log("audio codecs: ",Object.keys(this.audio_codecs))):(this.audio_codec=null,this.audio_enabled=!1,this.warn("no valid audio codecs found"))}_sound_start_receiving(){if(!this.audio_framework||!this.audio_codec){var codecs_supported=MediaSourceUtil.get_supported_codecs(this.audio_mediasource_enabled,this.audio_aurora_enabled,!1),codecs_supported=MediaSourceUtil.get_best_codec(codecs_supported);if(!codecs_supported)return void this.log("no codec found");codecs_supported=codecs_supported.split(":");this.audio_framework=codecs_supported[0],this.audio_codec=codecs_supported[1]}try{this.audio_buffers=[],this.audio_buffers_count=0,"mediasource"==this.audio_framework?this._sound_start_mediasource():this._sound_start_aurora()}catch(error){this.exc(error,"error starting audio player")}}_send_sound_start(){this.log(`audio: requesting ${this.audio_codec} stream from the server`),this.send([PACKET_TYPES.sound_control,"start",this.audio_codec])}_sound_start_aurora(){this.audio_aurora_ctx=AV.Player.fromXpraSource(),this._send_sound_start()}_sound_start_mediasource(){var me=this;function audio_error(event){me.media_source?(me.audio?(me.error(event+" error: "+me.audio.error),me.audio.error&&me.error(MediaSourceConstants.ERROR_CODE[me.audio.error.code])):me.error(event+" error"),me.close_audio()):me.debug("audio","media_source is closed, ignoring audio error: "+event)}this.media_source=MediaSourceUtil.getMediaSource(),this.debug&&MediaSourceUtil.addMediaSourceEventDebugListeners(this.media_source,"audio"),this.media_source.addEventListener("error",e=>audio_error("audio source")),this.audio=document.createElement("audio"),this.audio.setAttribute("autoplay",!0),this.debug&&MediaSourceUtil.addMediaElementEventDebugListeners(this.audio,"audio"),this.audio.addEventListener("play",()=>this.clog("audio play!")),this.audio.addEventListener("error",()=>audio_error("audio")),document.body.append(this.audio),this.audio.src=window.URL.createObjectURL(this.media_source),this.audio_buffers=[],this.audio_buffers_count=0,this.audio_source_ready=!1,this.clog("audio waiting for source open event on",this.media_source),this.media_source.addEventListener("sourceopen",()=>{if(this.log("audio media source open"),this.audio_source_ready)this.warn("ignoring: source already open");else{var asb,codec_string=MediaSourceConstants.CODEC_STRING[this.audio_codec];if(null==codec_string)this.error(`invalid codec '${this.audio_codec}'`),this.close_audio();else{this.log(`using audio codec string for ${this.audio_codec}: `+codec_string);try{asb=this.media_source.addSourceBuffer(codec_string)}catch(error){return this.exc(error,"audio setup error for",codec_string),void this.close_audio()}(this.audio_source_buffer=asb).mode="sequence",this.debug_categories.includes("audio")&&MediaSourceUtil.addSourceBufferEventDebugListeners(asb,"audio"),asb.addEventListener("error",e=>audio_error("audio buffer")),this.audio_source_ready=!0,this._send_sound_start()}}})}_send_sound_stop(){this.log("audio: stopping stream"),this.send([PACKET_TYPES.sound_control,"stop"])}close_audio(){this.connected&&this.audio_enabled&&this._send_sound_stop(),"mediasource"==this.audio_framework?this._close_audio_mediasource():this._close_audio_aurora(),this.on_audio_state_change("stopped","closed")}_close_audio_aurora(){if(this.audio_aurora_ctx){if(this.audio_aurora_ctx.context)try{this.audio_aurora_ctx.context.close()}catch(error){this.debug("audio","error closing context",error)}this.audio_aurora_ctx=null}}_close_audio_mediasource(){if(this.log(`close_audio_mediasource: audio_source_buffer=${this.audio_source_buffer}, media_source=${this.media_source}, audio=`+this.audio),this.audio_source_ready=!1,this.audio){if(this.media_source){try{this.audio_source_buffer&&(this.media_source.removeSourceBuffer(this.audio_source_buffer),this.audio_source_buffer=null),"open"==this.media_source.readyState&&this.media_source.endOfStream()}catch(error){this.exc(error,"audio media source EOS error")}this.media_source=null}this._remove_audio_element()}}_remove_audio_element(){if(null!=this.audio){this.audio.src="",this.audio.load();try{this.audio.remove()}catch(error){this.debug("audio","failed to remove audio from page:",error)}this.audio=null}}_process_sound_data(packet){try{var codec=Utilities.s(packet[1]),buf=packet[2],options=packet[3],metadata=packet[4];codec!=this.audio_codec?(this.error(`invalid audio codec '${codec}' (expected ${this.audio_codec}), stopping audio stream`),this.close_audio()):(1==options["start-of-stream"]&&this._audio_start_stream(),buf&&0<buf.length&&this.add_sound_data(codec,buf,metadata),1==options["end-of-stream"]&&(this.log("received end-of-stream from server"),this.close_audio()))}catch(error){this.on_audio_state_change("error",""+error),this.exc(error,"sound data error"),this.close_audio()}}on_audio_state_change(newstate,details){this.debug("on_audio_state_change:",newstate,details),this.audio_state=newstate}add_sound_data(codec,buf,metadata){var MIN_START_BUFFERS=4;if(this.debug("audio","sound-data: ",codec,", ",buf.length,"bytes"),250<=this.audio_buffers.length)this.warn(`audio queue overflowing: ${this.audio_buffers.length}, stopping`),this.on_audio_state_change("error","queue overflow"),this.close_audio();else{if(metadata){for(var index in this.debug("audio","audio metadata=",metadata),metadata){var metadatum=metadata[index];this.debug("audio","metadata[",index,"]=",metadatum,", length=",metadatum.length,", type=",Object.prototype.toString.call(metadatum)),this.audio_buffers.push(Utilities.u(metadatum))}MIN_START_BUFFERS=1}null!=buf&&this.audio_buffers.push(buf);var ab=this.audio_buffers;if(this._audio_ready()&&(0<this.audio_buffers_count||ab.length>=MIN_START_BUFFERS)){if(1==ab.length)buf=ab[0];else{var size=ab.reduce((accumulator,value)=>accumulator+value.length,0);buf=new Uint8Array(size);for(var size=0,index=0,stop=ab.length;index<stop;++index){var v=ab[index];0<v.length&&(buf.set(v,size),size+=v.length)}}this.audio_buffers_count+=1,this.push_audio_buffer(buf),this.audio_buffers=[]}}}_audio_start_stream(){var play;this.debug("audio",`audio start of ${this.audio_framework} ${this.audio_codec} stream`),"playing"!=this.audio_state&&"waiting"!=this.audio_state&&(this.on_audio_state_change("waiting",`${this.audio_framework} playing ${this.audio_codec} stream`),"mediasource"==this.audio_framework?null==(play=this.audio.play())?(this.on_audio_state_change("error","no promise"),this.close_audio()):play.then(result=>{this.debug("audio","stream playing",result)},error=>{this.on_audio_state_change("error","stream failed:"+error),this.close_audio()}):"http-stream"==this.audio_framework?this.log("invalid start-of-stream data for http-stream framework"):"aurora"==this.audio_framework?this.audio_aurora_ctx.play():(this.on_audio_state_change("error","unknown framework "+this.audio_framework),this.close_audio()))}_audio_ready(){var asb;return"mediasource"==this.audio_framework?(this.audio&&(this.debug("audio","mediasource state=",MediaSourceConstants.READY_STATE[this.audio.readyState],", network state=",MediaSourceConstants.NETWORK_STATE[this.audio.networkState]),this.debug("audio","audio paused=",this.audio.paused,", queue size=",this.audio_buffers.length,", source ready=",this.audio_source_ready,", source buffer updating=",this.audio_source_buffer.updating)),null!=(asb=this.audio_source_buffer)&&!asb.updating):null!=this.audio_aurora_ctx}push_audio_buffer(buf){var b;"mediasource"==this.audio_framework?(this.audio_source_buffer.appendBuffer(buf),(b=this.audio_source_buffer.buffered)&&0<b.length&&(b=b.end(0),b=Math.round(1e3*(b-this.audio.currentTime)),this.debug("audio","buffer size=",b,"ms, currentTime=",this.audio.currentTime))):(this.audio_aurora_ctx.asset.source._on_data(buf),this.debug("audio","playing=",this.audio_aurora_ctx.playing,"buffered=",this.audio_aurora_ctx.buffered,"currentTime=",this.audio_aurora_ctx.currentTime,"duration=",this.audio_aurora_ctx.duration),this.audio_aurora_ctx.format&&this.debug("audio","formatID=",this.audio_aurora_ctx.format.formatID,"sampleRate=",this.audio_aurora_ctx.format.sampleRate),this.debug("audio","active=",this.audio_aurora_ctx.asset.active,"decoder=",this.audio_aurora_ctx.asset.decoder,"demuxer=",this.audio_aurora_ctx.demuxer)),this.on_audio_state_change("playing","")}get_clipboard_buffer(){return this.clipboard_buffer}get_clipboard_datatype(){return this.clipboard_datatype}send_clipboard_token(data,data_format){this.clipboard_enabled&&this.connected&&((data_format=data_format)||(data_format=[TEXT_PLAIN,UTF8_STRING],this.clipboard_preferred_format==UTF8_STRING&&(data_format=[UTF8_STRING,TEXT_PLAIN])),this.debug("clipboard","sending clipboard token with data:",data,"as",data_format),data_format=data?[PACKET_TYPES.clipboard_token,"CLIPBOARD",data_format,UTF8_STRING,UTF8_STRING,8,"bytes",data,!0,!0,!0]:[PACKET_TYPES.clipboard_token,"CLIPBOARD",[],"","",8,"bytes","",!0,!0,!0],this.send(data_format))}_process_clipboard_token(packet){if(this.clipboard_enabled){var selection=packet[1],targets=[],target=null,dtype=null,dformat=null,wire_encoding=null,wire_data=null,packet=(3<=packet.length&&(targets=packet[2]),8<=packet.length&&(target=packet[3],dtype=packet[4],dformat=packet[5],wire_encoding=packet[6],wire_data=packet[7],this.clipboard_server_buffers[selection]=[target,dtype,dformat,wire_encoding,wire_data]),target&&this.clipboard_targets.includes(target));if(this.debug("clipboard","clipboard token received"),this.debug("clipboard","targets=",targets),this.debug("clipboard","target=",target,"is valid:",packet),this.debug("clipboard","dtype=",dtype,"dformat=",dformat,"wire-encoding=",wire_encoding),packet)if(dtype.toLowerCase().includes("text")||dtype.toLowerCase().includes("string")){try{wire_data=Utilities.Uint8ToString(wire_data)}catch{}this.clipboard_buffer!=wire_data&&(this.clipboard_datatype=dtype,this.clipboard_buffer=wire_data,this.clipboard_pending=!0,navigator.clipboard)&&navigator.clipboard.writeText&&navigator.clipboard.writeText(wire_data).then(()=>{this.debug("clipboard","writeText succeeded"),this.clipboard_pending=!1},()=>this.debug("clipboard","writeText failed"))}else CLIPBOARD_IMAGES&&"image/png"==dtype&&8==dformat&&"bytes"==wire_encoding&&navigator.clipboard&&Object.hasOwn(navigator.clipboard,"write")&&(this.debug("clipboard","png image received"),selection=new Blob([wire_data],{type:dtype}),this.debug("clipboard","created blob",selection),targets=new ClipboardItem({"image/png":selection}),this.debug("clipboard","created ClipboardItem",targets),this.debug("clipboard","created ClipboardItem list",target=[targets]),navigator.clipboard.write(target).then(()=>this.debug("clipboard","copied png image to clipboard"),error=>this.debug("clipboard","failed to set png image",error)))}}_process_set_clipboard_enabled(packet){this.clipboard_enabled&&(this.clipboard_enabled=packet[1],this.log(`server set clipboard state to ${packet[1]} reason was: `+packet[2]))}_process_clipboard_request(packet){var request_id=packet[1],selection=packet[2];if(this.debug("clipboard",selection+" request"),"CLIPBOARD"!=selection)this.send_clipboard_string(request_id,selection,"");else{if(navigator.clipboard){if(Object.hasOwn((navigator.clipboard,"read")))return this.debug("clipboard","request using read()"),void navigator.clipboard.read().then(data=>{for(var index in this.debug("clipboard","request via read() data=",data),data){var item_type,item=data[index];this.debug("clipboard","item",index,"types:",item.types);for(item_type of item.types){if(item_type==TEXT_PLAIN)return void item.getType(item_type).then(blob=>{var fileReader=new FileReader;fileReader.addEventListener("load",event=>this.send_clipboard_string(request_id,selection,event.target.result)),fileReader.readAsText(blob)},error=>{this.debug("clipboard",`getType('${item_type}') failed`,error),this.resend_clipboard_server_buffer()});if("image/png"==item_type)return void item.getType(item_type).then(blob=>{var fileReader=new FileReader;fileReader.addEventListener("load",event=>this.send_clipboard_contents(request_id,selection,item_type,8,"bytes",event.target.result)),fileReader.readAsText(blob)},error=>{this.debug("clipboard",`getType('${item_type}') failed`,error),this.resend_clipboard_server_buffer(request_id,selection)})}}},error=>{this.debug("clipboard","read() failed:",error),this.resend_clipboard_server_buffer(request_id,selection)});if(Object.hasOwn((navigator.clipboard,"readText")))return this.debug("clipboard","clipboard request using readText()"),void navigator.clipboard.readText().then(text=>{this.debug("clipboard","clipboard request via readText() text=",text);var primary_server_buffer=this.clipboard_server_buffers.PRIMARY;primary_server_buffer&&8==primary_server_buffer[2]&&"bytes"==primary_server_buffer[3]&&text==primary_server_buffer[4]?(this.debug("clipboard request: using backup value"),this.resend_clipboard_server_buffer(request_id,selection)):this.send_clipboard_string(request_id,selection,text)},error=>{this.debug("clipboard","readText() failed:",error),this.resend_clipboard_server_buffer(request_id,selection)})}packet=this.get_clipboard_buffer()||"";this.send_clipboard_string(request_id,selection,packet,UTF8_STRING)}}resend_clipboard_server_buffer(request_id,selection){var dtype,dformat,wire_encoding,server_buffer=this.clipboard_server_buffers.CLIPBOARD;this.debug("clipboard","resend_clipboard_server_buffer:",server_buffer),server_buffer?(dtype=server_buffer[1],dformat=server_buffer[2],wire_encoding=server_buffer[3],server_buffer=server_buffer[4],this.send_clipboard_contents(request_id,selection,dtype,dformat,wire_encoding,server_buffer)):this.send_clipboard_string(request_id,selection,"",UTF8_STRING)}send_clipboard_none(request_id,selection){request_id=[PACKET_TYPES.clipboard_contents_none,request_id,selection];this.debug("clipboard","sending clipboard-contents-none"),this.send(request_id)}send_clipboard_string(request_id,selection,clipboard_buffer,datatype){""==clipboard_buffer?this.send_clipboard_none(request_id,selection):(request_id=[PACKET_TYPES.clipboard_contents,request_id,selection,datatype||UTF8_STRING,8,"bytes",clipboard_buffer],this.debug("clipboard","send_clipboard_string: packet=",request_id),this.send(request_id))}send_clipboard_contents(request_id,selection,datatype,dformat,encoding,clipboard_buffer){""==clipboard_buffer?this.send_clipboard_none(request_id,selection):(request_id=[PACKET_TYPES.clipboard_contents,request_id,selection,datatype,dformat||8,encoding||"bytes",clipboard_buffer],this.send(request_id))}_process_send_file(packet){var basefilename=Utilities.s(packet[1]),mimetype=Utilities.s(packet[2]),printit=packet[3],filesize=packet[5],data=packet[6],options=packet[7]||{},packet=Utilities.s(packet[8]);if(filesize<=0||FILE_SIZE_LIMIT<filesize)this.error("send-file: invalid data size, received",data.length,"bytes, expected",filesize);else{if(data.length==filesize)return digest&&(digest.update(Utilities.ArrayBufferToString(data)),this.log("digest.update(",data,")"),!this.verify_digest(digest,options[digest.algorithm]))?void 0:void this._got_file(basefilename,data,printit,mimetype,options);if(packet){var chunk_id=Utilities.s(options["file-chunk-id"]||"");if(chunk_id)if(this.receive_chunks_in_progress.size>MAX_CONCURRENT_FILES)this.cancel_file(chunk_id,"too many concurrent files being downloaded",0);else{data=null;try{this.debug("file","streamSaver=",streamSaver),streamSaver.mitm="./mitm.html";data=streamSaver.createWriteStream(basefilename,{size:filesize}).getWriter();this.debug("file","stream writer=",data)}catch(error){data=[],this.error("cannot use streamSaver:",error)}var timer=setTimeout(()=>this._check_chunk_receiving(chunk_id,0),CHUNK_TIMEOUT),data=[Date.now(),data,basefilename,mimetype,printit,!0,filesize,options,digest,0,!1,packet,timer,0];this.receive_chunks_in_progress.set(chunk_id,data),this.send([PACKET_TYPES.ack_file_chunk,chunk_id,!0,"",0]),this.log("receiving chunks for",basefilename,"with transfer id",chunk_id)}else this.cerror("send-file: partial file is missing file-chunk-id")}else this.cerror("send-file: partial file is missing send-id")}}_check_chunk_receiving(chunk_id,chunk_no){var chunk_state=this.receive_chunks_in_progress.get(chunk_id);this.debug("file","check_chunk_receiving(",chunk_id,",",chunk_no,") chunk_state=",chunk_state),chunk_state&&!chunk_state[10]&&(chunk_state[12]=0)==chunk_state[13]&&(this.cerror("Error: chunked file transfer",chunk_id,"timed out"),this.receive_chunks_in_progress.delete(chunk_id))}cancel_all_files(reason="closing"){this.clog("cancel_all_files(",reason,") will cancel:",[...this.receive_chunks_in_progress.keys()]);for(var chunk_id of this.receive_chunks_in_progress.keys())this.cancel_file(chunk_id,reason)}active_file_transfers(){return this.receive_chunks_in_progress.size}cancel_file(chunk_id,message,chunk){var writer,chunk_state=this.receive_chunks_in_progress.get(chunk_id);chunk_state&&(chunk_state[10]=!0,(writer=chunk_state[1]).abort&&writer.abort(),chunk_state[1]=null,(writer=chunk_state[12])&&(clearTimeout(writer),chunk_state[12]=0),setTimeout(()=>this.receive_chunks_in_progress.delete(chunk_id),2e4)),this.send([PACKET_TYPES.ack_file_chunk,chunk_id,!1,message,chunk])}_process_send_file_chunk(packet){var chunk_id=Utilities.s(packet[1]),chunk=packet[2],file_data=packet[3],has_more=packet[4],chunk_state=(this.debug("file","_process_send_file_chunk(",chunk_id,chunk,file_data.length+" bytes",has_more,")"),this.receive_chunks_in_progress.get(chunk_id));if(chunk_state)if(chunk_state[10])this.debug("file","got chunk for a cancelled file transfer, ignoring it");else{has_more=chunk_state[6];if(chunk_state[13]+1!=chunk)this.cancel_file(chunk_id,`chunk number mismatch, expected ${chunk_state[13]+1} but got `+chunk);else{chunk_state[13]=chunk;var written=chunk_state[9]+file_data.length;if(has_more<written)this.cancel_file(chunk_id,"too much data received");else{has_more=chunk_state[1];if(has_more.write)try{var p=has_more.write(file_data);if(p)return void p.then(()=>{chunk_state[9]=written,this.file_chunk_written(packet)},error=>{var message="cannot write file data, download cancelled?";error&&(this.clog("write failed:",error),message=`cannot write file data: ${error}, download cancelled?`),this.cancel_file(chunk_id,message)});this.clog("write(..)=",p)}catch(error){return this.error(error),void this.cancel_file(chunk_id,"cannot write file data - download cancelled?")}else has_more.push(file_data);chunk_state[9]=written,this.file_chunk_written(packet)}}}else this.error("Error: cannot find the file transfer id",chunk_id),this.cancel_file(chunk_id,`file transfer id${chunk_id}not found`,chunk)}file_chunk_written(packet){var chunk_id=Utilities.s(packet[1]),chunk=packet[2],file_data=packet[3],packet=packet[4],chunk_state=this.receive_chunks_in_progress.get(chunk_id),writer=chunk_state[1],filesize=chunk_state[6],digest=chunk_state[8],written=chunk_state[9];if(digest&&digest.update(Utilities.Uint8ToString(file_data)),this.send([PACKET_TYPES.ack_file_chunk,chunk_id,!0,"",chunk]),packet)(file_data=chunk_state[12])&&clearTimeout(file_data),chunk_state[12]=setTimeout(()=>this._check_chunk_receiving(chunk_id,chunk),CHUNK_TIMEOUT);else if(this.receive_chunks_in_progress.delete(chunk_id),written!=filesize)this.cancel_file(chunk_id,`file size mismatch: expected a file of ${filesize} bytes but got `+written);else{packet=chunk_state[7];if(digest&&!this.verify_digest(digest,packet[digest.algorithm]))this.cancel_file(chunk_id,digest.algorithm+" checksum mismatch");else{var chunk_,file_data=chunk_state[0],written=Date.now()-file_data,digest=(this.clog(filesize,"bytes received in",chunk,"chunks, took",Math.round(1e3*written),"ms"),chunk_state[2]),file_data=chunk_state[3],written=chunk_state[4],data=new Uint8Array(filesize),start=0;if(writer.close)writer.close();else{for(chunk_ of chunk_state[1])data.set(chunk_,start),start+=chunk_.length;this._got_file(digest,data,file_data,written,file_data,packet)}}}}verify_digest(digest,expected_value){var algo=digest.algorithm,digest=digest.digest().data,digest=Utilities.convertToHex(digest);return digest!=expected_value.toLowerCase()?(this.error("Error verifying",algo,"file checksum"),this.error(" expected",expected_value,"but got",digest),!1):(this.log("verified",algo,"digest of file transfer"),!0)}_got_file(basefilename,data,printit,mimetype,options){printit?this.print_document(basefilename,data,mimetype):this.save_file(basefilename,data,mimetype)}save_file(filename,data,mimetype){this.file_transfer&&this.remote_file_transfer?(this.log(`saving ${data.length} bytes of ${mimetype=""==mimetype?"application/octet-binary":mimetype} data to filename `+filename),Utilities.saveFile(filename,data,{type:mimetype})):this.warn("Received file-transfer data but this is not enabled!")}print_document(filename,data,mimetype){var file;this.printing&&this.remote_printing?"application/pdf"!=mimetype?this.warn("Received unsupported print data mimetype: "+mimetype):(this.log(`got ${data.length} bytes of PDF to print`),file=new Blob([data],{type:mimetype}),file=URL.createObjectURL(file),!(file=window.open(file))||file.closed||void 0===file.closed?(this.warn("popup blocked, saving to file instead"),Utilities.saveFile(filename,data,{type:mimetype})):file.print()):this.warn("Received data to print but printing is not enabled!")}send_all_files(files){for(var f,index=0;f=files[index];index++)this.send_file(f)}send_file(f){clog("send_file:",f.name,", type:",f.type,", size:",f.size);var fileReader=new FileReader;fileReader.onloadend=event_=>{event_=new Uint8Array(event_.target.result);this.do_send_file(f.name,f.type,f.size,event_)},fileReader.readAsArrayBuffer(f)}do_send_file(filename,mimetype,size,buffer){if(this.file_transfer&&this.remote_file_transfer){var cdata=buffer,options={},chunk_size=Math.min(FILE_CHUNKS_SIZE,this.remote_file_chunks||0);if(0<chunk_size&&chunk_size<size){if(this.send_chunks_in_progress.size>=MAX_CONCURRENT_FILES)throw Exception("too many file transfers in progress:"+this.send_chunks_in_progress.size);var chunk_id=Utilities.getHexUUID(),timer=(options["file-chunk-id"]=chunk_id,setTimeout(()=>{this._check_chunk_sending(chunk_id,0)},CHUNK_TIMEOUT)),buffer=[Date.now(),buffer,chunk_size,timer,0];this.send_chunks_in_progress.set(chunk_id,buffer),cdata="",this.debug("file","using chunks, sending initial file-chunk-id=",chunk_id,", for chunk size",chunk_size)}else this.debug("file","sending full file:",size,"bytes, chunk size",chunk_size);timer=[PACKET_TYPES.send_file,filename,mimetype,!1,this.remote_open_files,size,cdata,options];this.send(timer)}else this.warn("cannot send file: file transfers are disabled!")}_check_chunk_sending(chunk_id,chunk_no){var chunk_state=this.send_chunks_in_progress.get(chunk_id);this.debug("file","chunk id",chunk_id,"chunk_no",chunk_no,"found chunk_state",Boolean(chunk_state)),chunk_state&&(chunk_state[3]=0,chunk_state[13]==chunk_no)&&(this.error("Error: chunked file transfer",chunk_id,"timed out"),this.error(" on chunk",chunk_no),this.cancel_sending(chunk_id))}cancel_sending(chunk_id){var timer,chunk_state=this.send_chunks_in_progress.get(chunk_id);this.debug("file","cancel_sending",chunk_id,"chunk state found:",Boolean(chunk_state)),chunk_state&&((timer=chunk_state[3])&&(chunk_state[3]=0,clearTimeout(timer)),this.send_chunks_in_progress.delete(chunk_id))}_process_ack_file_chunk(packet){this.debug("file","ack-file-chunk: ",packet);var chunk_id=Utilities.s(packet[1]),state=packet[2],error_message=packet[3],chunk=packet[4];if(state){packet=this.send_chunks_in_progress.get(chunk_id);if(packet)if(packet[4]!=chunk)this.error("Error: chunk number mismatch",packet,"vs",chunk),this.cancel_sending(chunk_id);else{var state=packet[0],chunk_size=packet[2],timer=packet[3];if(packet=packet[1]){if(chunk_size<=0)throw Exception("invalid chunk size "+chunk_size);var cdata=packet.subarray(0,chunk_size),packet=packet.subarray(chunk_size);chunk+=1,timer&&clearTimeout(timer),timer=setTimeout(()=>this._check_chunk_sending(chunk_id,chunk),CHUNK_TIMEOUT),this.send_chunks_in_progress.set(chunk_id,[state,packet,chunk_size,timer,chunk]),this.send([PACKET_TYPES.send_file_chunk,chunk_id,chunk,cdata,0<packet.length])}else timer=Date.now()-state,cdata=8*chunk*chunk_size/timer,this.log(chunk,"chunks of",chunk_size,"bytes sent in",Math.round(timer),"ms",cdata,"bps"),this.cancel_sending(chunk_id)}else this.error("Error: cannot find the file transfer id '%r'",chunk_id)}else this.debug("file","the remote end is cancelling the file transfer:"),this.debug("file"," %s",Utilities.s(error_message)),this.cancel_sending(chunk_id)}start_command(name,command,ignore){name=[PACKET_TYPES.start_command,name,command,ignore];this.send(name)}_process_open_url(packet){var new_window,packet=packet[1];this.open_url?(this.clog("opening url:",packet),(new_window=window.open(packet,"_blank"))&&!new_window.closed&&void 0!==new_window.closed||window.doNotification("",0,"Open URL",`<a href="${packet}" rel="noopener" target="_blank">${packet}</a>`,10,null,null,null,null,null)):(this.cwarn("Warning: received a request to open URL",packet),this.clog(" but opening of URLs is disabled"))}}